<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSP Brush Converter Pro - Ultimate V5</title>
    <meta name="description" content="Convert Procreate, Photoshop ABR, and custom brushes to Clip Studio Paint format online for free">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
             background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#fff}
        .container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,.95);
                   border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
        .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:30px;text-align:center}
        .header h1{font-size:clamp(1.5em,4vw,2.5em);margin-bottom:10px;color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,.2)}
        .header p{opacity:.9;font-size:1.1em}
        .content{padding:clamp(20px,4vw,40px);color:#333}
        #dropZone{border:3px dashed #667eea;border-radius:15px;padding:clamp(40px,8vw,60px) clamp(20px,4vw,30px);
                  text-align:center;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);
                  transition:all .3s;cursor:pointer;margin-bottom:30px}
        #dropZone:hover{border-color:#764ba2;transform:translateY(-2px);box-shadow:0 10px 30px rgba(102,126,234,.3)}
        #dropZone.dragover{border-color:#00d4ff;background:linear-gradient(135deg,#e0f7fa 0%,#b2ebf2 100%);transform:scale(1.02)}
        #dropZone svg{width:clamp(48px,8vw,64px);height:clamp(48px,8vw,64px);margin-bottom:20px;opacity:.7}
        .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
        .control-group{background:#f8f9fa;padding:20px;border-radius:10px;border:1px solid #e9ecef}
        .control-group label{display:block;font-weight:600;margin-bottom:10px;color:#495057}
        select,input[type=text]{width:100%;padding:12px;border:2px solid #dee2e6;border-radius:8px;font-size:1em;transition:border-color .3s}
        select:focus,input[type=text]:focus{outline:none;border-color:#667eea}
        .btn{padding:15px 40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
             color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:1.1em;font-weight:600;
             transition:all .3s;box-shadow:0 4px 15px rgba(102,126,234,.4);display:inline-flex;align-items:center;gap:10px;width:100%;justify-content:center}
        .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.6)}
        .btn:disabled{background:#adb5bd;cursor:not-allowed;box-shadow:none}
        .file-input-group{display:flex;gap:10px;margin-top:20px}
        .file-input-group .btn{flex:1}
        .status-bar{background:#e9ecef;padding:15px;border-radius:8px;margin-bottom:20px;display:none;align-items:center;gap:10px}
        .status-bar.show{display:flex}
        .status-bar.success{background:#d4edda;color:#155724}
        .status-bar.error{background:#f8d7da;color:#721c24}
        .status-bar.info{background:#d1ecf1;color:#0c5460}
        #log{background:#1e1e1e;padding:20px;border-radius:10px;max-height:400px;overflow-y:auto;
             font-family:'Courier New',monospace;font-size:.9em;line-height:1.6}
        .log-entry{padding:5px 0;border-left:3px solid transparent;padding-left:10px;margin-bottom:5px}
        .log-entry.success{color:#4caf50;border-color:#4caf50}
        .log-entry.info{color:#2196f3;border-color:#2196f3}
        .log-entry.error{color:#f44336;border-color:#f44336}
        .log-entry.warning{color:#ff9800;border-color:#ff9800}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:30px}
        .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;border-radius:10px;color:#fff;text-align:center}
        .stat-card .value{font-size:clamp(1.5em,3vw,2em);font-weight:bold;margin-bottom:5px}
        .stat-card .label{opacity:.9;font-size:.9em}
        .progress-bar{width:100%;height:8px;background:#e9ecef;border-radius:4px;overflow:hidden;margin-top:10px;display:none}
        .progress-bar.show{display:block}
        .progress-fill{height:100%;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);width:0%;transition:width .3s}
        .format-info{margin-top:10px;padding:10px;background:#e3f2fd;border-radius:5px;font-size:.9em;color:#1565c0}
        .warning-box{margin-top:10px;padding:10px;background:#fff3cd;border-radius:5px;font-size:.85em;color:#856404}
        .footer{text-align:center;padding:20px;margin-top:30px;color:rgba(255,255,255,.7);font-size:.9em}
        @media(max-width:768px){.controls{grid-template-columns:1fr}.file-input-group{flex-direction:column}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CSP Brush Converter Pro</h1>
            <p>Convert Procreate, ABR, and custom brushes to Clip Studio Paint format</p>
        </div>
        <div class="content">
            <div id="dropZone">
                <svg fill="currentColor" viewBox="0 0 20 20"><path d="M16.88 9.1A4 4 0 0 1 16 17H5a5 5 0 0 1-1-9.9V7a3 3 0 0 1 4.52-2.59A4.98 4.98 0 0 1 17 8c0 .38-.04.74-.12 1.1zM11 11h3l-4-4-4 4h3v3h2v-3z"/></svg>
                <h2 style="color:#667eea;margin-bottom:10px">Drop Files Here</h2>
                <p style="color:#6c757d;margin-bottom:20px">Supports: .brushset, .zip, .abr (v1-6+), .brush, folders</p>
                <div class="file-input-group">
                    <button class="btn" id="browseFilesBtn">Browse Files</button>
                    <button class="btn" id="browseFolderBtn">Browse Folder</button>
                </div>
                <input type="file" id="fileInput" multiple accept=".brushset,.zip,.abr,.brush,.json,.png" style="display:none">
                <input type="file" id="folderInput" webkitdirectory directory style="display:none">
            </div>

            <div class="stats" id="stats" style="display:none">
                <div class="stat-card"><div class="value" id="fileCount">0</div><div class="label">Files Loaded</div></div>
                <div class="stat-card"><div class="value" id="brushCount">0</div><div class="label">Brushes Found</div></div>
                <div class="stat-card"><div class="value" id="convertedCount">0</div><div class="label">Converted</div></div>
                <div class="stat-card"><div class="value" id="textureCount">0</div><div class="label">Textures</div></div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label for="targetFormat">Output Format</label>
                    <select id="targetFormat">
                        <option value="sut">Clip Studio Paint (.sut) - Full</option>
                        <option value="png">Brush Tip PNGs Only</option>
                        <option value="json">JSON + PNGs (Dev)</option>
                    </select>
                    <div class="format-info" id="formatInfo"></div>
                </div>
                <div class="control-group">
                    <label for="packageName">Package Name</label>
                    <input type="text" id="packageName" placeholder="My Custom Brushes" value="Converted Brushes">
                </div>
                <div class="control-group">
                    <label for="authorName">Author Name</label>
                    <input type="text" id="authorName" placeholder="Artist Name">
                </div>
                <div class="control-group">
                    <label for="compressionLevel">Compression</label>
                    <select id="compressionLevel">
                        <option value="1">Fast</option>
                        <option value="6" selected>Balanced</option>
                        <option value="9">Maximum</option>
                    </select>
                </div>
            </div>

            <button id="convertBtn" class="btn" disabled>Convert & Download</button>
            <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
            <div id="statusBar" class="status-bar"><span id="statusText">Ready</span></div>
            <div id="log"></div>
        </div>
        <div class="footer">
            <p>CSP Brush Converter Pro - Ultimate V5 | All processing happens in your browser - no files are uploaded to any server</p>
        </div>
    </div>

    <script>
        // JavaScript code from the previous fixed version goes here
        // (The entire script section from our fixed version)
        
        /*=====================================================================
          GLOBAL INIT
        =====================================================================*/
        let SQL, SQL_READY = false;
        window.addEventListener('load', async () => {
            try {
                const sqlModule = await initSqlJs({locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${f}`});
                SQL = sqlModule;
                SQL_READY = true;
                Logger.info('SQL.js ready');
                if(AppState.filesLoaded) UI.enableConvertButton();
                if (!window.showDirectoryPicker && !('webkitdirectory' in document.createElement('input'))) {
                    UI.e.browseFolderBtn.disabled = true;
                    UI.e.browseFolderBtn.title = "Folder selection requires Chrome/Edge";
                    Logger.warning("Folder selection not supported");
                }
            } catch(e) {
                Logger.error('SQL.js init failed: '+e.message);
                UI.showStatus('Database engine error', 'error');
            }
        });

        // ... rest of the JavaScript code from our fixed version ...
        // [Include all the JavaScript code we fixed earlier]

    </script>
</body>
</html>
