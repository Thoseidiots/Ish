<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CSP Subtool Converter Pro - Hybrid Edition (JS + Python)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.min.js"></script>
<!-- JSZip removed - was only used for Lua script generation which is not supported -->
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100% );min-height:100vh;padding:20px;color:#fff}
.container{max-width:1400px;margin:0 auto;background:rgba(255,255,255,0.95);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden}
.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:30px;text-align:center}
.header h1{font-size:clamp(1.5em,4vw,2.5em);margin-bottom:10px;color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,0.2)}
.header p{opacity:0.9;font-size:1.1em}
.content{padding:clamp(20px,4vw,40px);color:#333}
.mode-selector{display:flex;gap:10px;margin-bottom:20px;background:#f8f9fa;padding:15px;border-radius:10px}
.mode-btn{flex:1;padding:12px;border:2px solid #dee2e6;background:#fff;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s}
.mode-btn.active{border-color:#667eea;background:#667eea;color:#fff}
.mode-btn:hover:not(.active){border-color:#667eea;background:#f8f9ff}
#dropZone{border:3px dashed #667eea;border-radius:15px;padding:clamp(40px,8vw,60px) clamp(20px,4vw,30px);text-align:center;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);transition:all 0.3s ease;cursor:pointer;margin-bottom:30px}
#dropZone:hover{border-color:#764ba2;transform:translateY(-2px);box-shadow:0 10px 30px rgba(102,126,234,0.3)}
#dropZone.dragover{border-color:#00d4ff;background:linear-gradient(135deg,#e0f7fa 0%,#b2ebf2 100%);transform:scale(1.02)}
#dropZone svg{width:clamp(48px,8vw,64px);height:clamp(48px,8vw,64px);margin-bottom:20px;opacity:0.7}
.controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:30px}
.control-group{background:#f8f9fa;padding:20px;border-radius:10px;border:1px solid #e9ecef}
.control-group label{display:block;font-weight:600;margin-bottom:8px;color:#495057;font-size:0.9em}
input[type=text],input[type=number],select{width:100%;padding:10px;border:2px solid #dee2e6;border-radius:8px;font-size:1em;transition:border-color 0.3s}
input[type=text]:focus,input[type=number]:focus,select:focus{outline:none;border-color:#667eea}
input[type=range]{width:100%;margin:10px 0}
.range-value{display:inline-block;background:#667eea;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.85em;margin-left:10px}
.btn{padding:15px 40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:1.1em;font-weight:600;transition:all 0.3s;box-shadow:0 4px 15px rgba(102,126,234,0.4);display:inline-flex;align-items:center;gap:10px;width:100%;justify-content:center}
.btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,0.6)}
.btn:disabled{background:#adb5bd;cursor:not-allowed;box-shadow:none}
.btn-secondary{background:linear-gradient(135deg,#6c757d 0%,#495057 100%);box-shadow:0 4px 15px rgba(108,117,125,0.4)}
.btn-secondary:hover:not(:disabled){box-shadow:0 6px 20px rgba(108,117,125,0.6)}
.btn-danger{background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);box-shadow:0 4px 15px rgba(220,53,69,0.4)}
.btn-danger:hover:not(:disabled){box-shadow:0 6px 20px rgba(220,53,69,0.6)}
.btn-success{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);box-shadow:0 4px 15px rgba(40,167,69,0.4)}
.btn-success:hover:not(:disabled){box-shadow:0 6px 20px rgba(40,167,69,0.6)}
.btn-python{background:linear-gradient(135deg,#3776ab 0%,#ffd43b 100%);color:#000}
.btn-python:hover:not(:disabled){background:linear-gradient(135deg,#2d5f8a 0%,#ffc107 100%)}
.status-bar{background:#e9ecef;padding:15px;border-radius:8px;margin-bottom:20px;display:none;align-items:center;gap:10px}
.status-bar.show{display:flex}
.status-bar.success{background:#d4edda;color:#155724}
.status-bar.error{background:#f8d7da;color:#721c24}
.status-bar.info{background:#d1ecf1;color:#0c5460}
.status-bar.warning{background:#fff3cd;color:#856404}
#log{background:#1e1e1e;padding:20px;border-radius:10px;max-height:400px;overflow-y:auto;font-family:'Courier New',monospace;font-size:0.9em;line-height:1.6}
.log-entry{padding:5px 0;border-left:3px solid transparent;padding-left:10px;margin-bottom:5px}
.log-entry.success{color:#4caf50;border-color:#4caf50}
.log-entry.info{color:#2196f3;border-color:#2196f3}
.log-entry.error{color:#f44336;border-color:#f44336}
.log-entry.warning{color:#ff9800;border-color:#ff9800}
.log-entry.python{color:#3776ab;border-color:#3776ab}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:30px}
.stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;border-radius:10px;color:#fff;text-align:center}
.stat-card .value{font-size:clamp(1.5em,3vw,2em);font-weight:bold;margin-bottom:5px}
.stat-card .label{opacity:0.9;font-size:0.9em}
.progress-bar{width:100%;height:8px;background:#e9ecef;border-radius:4px;overflow:hidden;margin-top:10px;display:none}
.progress-bar.show{display:block}
.progress-fill{height:100%;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);width:0%;transition:width 0.3s}
.format-info{margin-top:10px;padding:10px;background:#e3f2fd;border-radius:5px;font-size:0.9em;color:#1565c0}
.import-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:15px}
.preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-top:20px}
.preview-item{text-align:center}
.preview-item img{width:100%;height:100px;object-fit:contain;border:1px solid #dee2e6;border-radius:5px;background:#fff}
.preview-item p{font-size:0.8em;margin-top:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pressure-curve-editor{margin-top:15px;padding:15px;background:#f8f9fa;border-radius:8px}
.curve-canvas{width:100%;height:150px;border:1px solid #dee2e6;border-radius:5px;background:#fff;cursor:crosshair;margin-top:10px;touch-action:none}
.checkbox-group{display:flex;align-items:center;margin:10px 0}
.checkbox-group input[type=checkbox]{margin-right:10px;width:auto}
.tabs{display:flex;border-bottom:2px solid #dee2e6;margin-bottom:20px;overflow-x:auto;flex-wrap:wrap}
.tab{padding:10px 20px;cursor:pointer;background:none;border:none;border-bottom:2px solid transparent;color:#495057;font-weight:500;white-space:nowrap;flex:1 0 50%}
.tab.active{border-bottom-color:#667eea;color:#667eea}
.tab-content{display:none}
.tab-content.active{display:block}
.footer{text-align:center;padding:20px;margin-top:30px;color:rgba(255,255,255,0.7);font-size:0.9em}
.info-banner{background:#d1ecf1;border:1px solid #bee5eb;border-radius:8px;padding:15px;margin-bottom:20px;color:#0c5460}
.python-banner{background:#e3f2fd;border:1px solid #90caf9;border-radius:8px;padding:15px;margin-bottom:20px;color:#0d47a1}
.template-selector{background:#e7f3ff;border:2px solid #667eea;border-radius:10px;padding:20px;margin-bottom:20px}
.template-selector h3{color:#667eea;margin-bottom:15px}
.template-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px}
.template-option{background:#fff;padding:15px;border-radius:8px;border:1px solid #dee2e6;cursor:pointer;transition:all 0.3s}
.template-option:hover{border-color:#667eea;box-shadow:0 4px 12px rgba(102,126,234,0.2)}
.template-option.selected{border-color:#667eea;background:#f8f9ff}
.template-option h4{margin-bottom:5px;color:#495057}
.template-option p{font-size:0.85em;color:#6c757d;margin-bottom:10px}
.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9999}
.loading-overlay.show{display:flex}
.loading-spinner{width:50px;height:50px;border:5px solid #f3f3f3;border-top:5px solid #667eea;border-radius:50%;animation:spin 1s linear infinite}
.button-group{display:flex;gap:10px;margin-bottom:20px}
.button-group .btn{flex:1}
.python-output{background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:15px;margin-top:15px;font-family:monospace;font-size:0.9em;max-height:300px;overflow-y:auto}
.python-output pre{margin:0;white-space:pre-wrap}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.failed-brushes{background:#f8d7da;border:1px solid #f5c6cb;border-radius:8px;padding:15px;margin-top:20px;color:#721c24}
.failed-brushes h4{margin-bottom:10px}
.failed-brushes ul{list-style-position:inside;margin:0}
.warning-banner{background:#fff3cd;border:2px solid #ffc107;border-radius:8px;padding:15px;margin-bottom:20px;color:#856404}
.warning-banner h4{margin-bottom:10px;color:#856404}
.warning-banner ul{margin-left:20px;margin-top:10px}
.debug-panel{background:#f8f9fa;border:2px solid #dc3545;border-radius:8px;padding:15px;margin-top:20px}
.debug-panel h4{color:#dc3545;margin-bottom:10px}
.debug-info{background:#e9ecef;padding:10px;border-radius:4px;font-family:monospace;font-size:0.8em;max-height:200px;overflow-y:auto}
.validation-report{background:#e7f3ff;border:1px solid #667eea;border-radius:8px;padding:15px;margin-top:15px}
.validation-report h5{color:#667eea;margin-bottom:10px}
.validation-item{padding:5px 0;border-bottom:1px solid #dee2e6}
.validation-item:last-child{border-bottom:none}
.validation-pass{color:#28a745}
.validation-fail{color:#dc3545}
.validation-warn{color:#ffc107}
.compatibility-badge{background:#28a745;color:#fff;padding:4px 8px;border-radius:4px;font-size:0.8em;margin-left:10px}
.schema-comparison{background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:15px;margin-top:15px}
.schema-comparison table{width:100%;border-collapse:collapse}
.schema-comparison th,.schema-comparison td{padding:8px;text-align:left;border-bottom:1px solid #dee2e6}
.schema-comparison th{background:#e9ecef;font-weight:600}
.schema-status{padding:2px 6px;border-radius:3px;font-size:0.8em}
.schema-status.ok{background:#d4edda;color:#155724}
.schema-status.error{background:#f8d7da;color:#721c24}
.schema-status.warning{background:#fff3cd;color:#856404}
@media(max-width:768px){.controls{grid-template-columns:1fr}.import-options{grid-template-columns:1fr}.curve-canvas{width:100% !important;height:200px !important}.button-group{flex-direction:column}.template-options{grid-template-columns:1fr}.mode-selector{flex-direction:column}}
</style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
<div class="loading-spinner"></div>
</div>
<div class="container">
<div class="header">
<h1>üé® CSP Subtool Converter Pro - Hybrid Edition</h1>
<p>JavaScript Client-Side + Python Server-Side Processing for Maximum Compatibility</p>
</div>
<div class="content">

<!-- Mode Selection -->
<div class="mode-selector">
<button class="mode-btn active" data-mode="javascript">
üü¢ JavaScript Mode  

<small>Client-side processing, no server required</small>
</button>
<button class="mode-btn" data-mode="python">
üêç Python Mode  

<small>Server-side processing, advanced features</small>
</button>
</div>

<!-- Python Mode Banner -->
<div class="python-banner" id="pythonBanner" style="display:none">
<h4>üêç Python Processing Mode</h4>
<p>This mode uses a Python backend for enhanced processing capabilities including:</p>
<ul>
<li>‚úÖ Advanced image processing with PIL</li>
<li>‚úÖ Better PNG validation and optimization</li>
<li>‚úÖ Batch processing capabilities</li>
<li>‚úÖ Enhanced CSP schema validation</li>
<li>‚úÖ Professional-grade error handling</li>
</ul>
<div class="python-output" id="pythonOutput" style="display:none">
<pre id="pythonLog"></pre>
</div>
</div>

<div id="dropZone">
<svg fill="currentColor" viewBox="0 0 20 20"><path d="M16.88 9.1A4 4 0 0 1 16 17H5a5 5 0 0 1-1-9.9V7a3 3 0 0 1 4.52-2.59A4.98 4.98 0 0 1 17 8c0 .38-.04.74-.12 1.1zM11 11h3l-4-4-4 4h3v3h2v-3z"/></svg>
<h2 style="color:#667eea;margin-bottom:10px">Drop Brush Files Here</h2>
<p style="color:#6c757d;margin-bottom:20px">Supports: PNG, JPG, ABR, ZIP, .brushset, .sut files</p>
<div class="import-options">
<button class="btn btn-success" id="oneClickConvertBtn" style="font-size:1.1em;padding:12px 24px;">‚ö° One-Click Convert</button>
<button class="btn" id="importFilesBtn">üìÅ Import Brush Files</button>
<button class="btn" id="importZipBtn">üì¶ Import ZIP/Brushset</button>
<button class="btn btn-secondary" id="clearAllBtn">üóëÔ∏è Clear All</button>
</div>
<input type="file" id="fileInput" multiple accept=".png,.jpg,.jpeg,.abr,.zip,.brushset,.sut" style="display:none">
<input type="file" id="zipInput" accept=".zip,.brushset" style="display:none">
</div>

<div class="info-banner" id="infoBanner" style="display:none">
<strong>‚Ñπ Info:</strong> <span id="infoText"></span>
</div>

<div class="template-selector" id="templateSelector" style="display:none">
<h3>üìã Select SUT Template</h3>
<p style="color:#6c757d;margin-bottom:15px">Choose how to create the CSP-compatible database structure:</p>
<div class="template-options">
<div class="template-option" id="useDefaultTemplate">
<h4>üé® Use CSP Default Template</h4>
<p>Creates a verified CSP-compatible database with exact schema matching.</p>
<button class="btn btn-success" style="width:100%;margin-top:10px">Use Default</button>
</div>
<div class="template-option" id="useCustomTemplate">
<h4>üìÅ Load Custom Template</h4>
<p>Use your own .sut file as a template (schema validation applied).</p>
<button class="btn btn-secondary" style="width:100%;margin-top:10px">Load Template</button>
</div>
</div>
<input type="file" id="templateInput" accept=".sut" style="display:none">
</div>

<div class="stats" id="stats" style="display:none">
<div class="stat-card"><div class="value" id="fileCount">0</div><div class="label">Files Loaded</div></div>
<div class="stat-card"><div class="value" id="brushCount">0</div><div class="label">Brushes Found</div></div>
<div class="stat-card"><div class="value" id="convertedCount">0</div><div class="label">Converted</div></div>
<div class="stat-card"><div class="value" id="validatedCount">0</div><div class="label">CSP Validated</div></div>
</div>

<div id="previewContainer" style="display:none;margin-bottom:20px;">
<h3 style="margin-bottom:10px;color:#495057;">Brush Preview</h3>
<div id="previewGrid" class="preview-grid"></div>
</div>

<div class="tabs">
<button class="tab active" data-tab="basic">Basic Settings</button>
<button class="tab" data-tab="advanced">Advanced</button>
<button class="tab" data-tab="pressure">Pressure Curves</button>
<button class="tab" data-tab="debug">Debug & Validation</button>
</div>

<div id="basic" class="tab-content active">
<div class="controls">
<div class="control-group">
<label for="packageName">Package Name (max 100 chars)</label>
<input type="text" id="packageName" placeholder="My Custom Brushes" value="CSP Compatible Brushes" maxlength="100">
</div>
<div class="control-group">
<label for="authorName">Author Name</label>
<input type="text" id="authorName" placeholder="Artist Name">
</div>
<div class="control-group">
<label for="compressionLevel">Compression</label>
<select id="compressionLevel">
<option value="1">Fast</option>
<option value="6" selected>Balanced</option>
<option value="9">Maximum</option>
</select>
</div>
<div class="control-group">
<label for="outputFormat">Output Format</label>
<select id="outputFormat">
<option value="sut">Clip Studio Paint (.sut) - 100% Compatible</option>
<option value="png">Brush Tip PNGs Only</option>
<option value="debug">Debug Analysis Only</option>
</select>
<div class="format-info" id="formatInfo"></div>
</div>
</div>
</div>

<div id="advanced" class="tab-content">
<div class="controls">
<div class="control-group">
<label for="brushSize">Brush Size <span class="range-value" id="brushSizeValue">50</span></label>
<input type="range" id="brushSize" min="1" max="500" value="50">
</div>
<div class="control-group">
<label for="opacity">Opacity <span class="range-value" id="opacityValue">80</span></label>
<input type="range" id="opacity" min="1" max="100" value="80">
</div>
<div class="control-group">
<label for="spacing">Spacing <span class="range-value" id="spacingValue">10</span></label>
<input type="range" id="spacing" min="1" max="200" value="10">
</div>
<div class="control-group">
<label for="hardness">Hardness <span class="range-value" id="hardnessValue">50</span></label>
<input type="range" id="hardness" min="1" max="100" value="50">
</div>
<div class="control-group">
<label for="angle">Angle <span class="range-value" id="angleValue">0</span>¬∞</label>
<input type="range" id="angle" min="0" max="360" value="0">
</div>
<div class="control-group">
<label for="density">Density <span class="range-value" id="densityValue">100</span></label>
<input type="range" id="density" min="1" max="100" value="100">
</div>
<div class="control-group">
<label for="smoothing">Smoothing <span class="range-value" id="smoothingValue">0</span></label>
<input type="range" id="smoothing" min="0" max="100" value="0">
</div>
<div class="control-group">
<label for="stabilization">Stabilization <span class="range-value" id="stabilizationValue">0</span></label>
<input type="range" id="stabilization" min="0" max="100" value="0">
</div>
<div class="control-group">
<div class="checkbox-group">
<input type="checkbox" id="textureMode">
<label for="textureMode">Texture Mode</label>
</div>
<div class="checkbox-group">
<input type="checkbox" id="sizePressure" checked>
<label for="sizePressure">Size Pressure</label>
</div>
<div class="checkbox-group">
<input type="checkbox" id="opacityPressure" checked>
<label for="opacityPressure">Opacity Pressure</label>
</div>
<div class="checkbox-group">
<input type="checkbox" id="densityPressure">
<label for="densityPressure">Density Pressure</label>
</div>
<div class="checkbox-group">
<input type="checkbox" id="antiAliasing" checked>
<label for="antiAliasing">Anti-Aliasing</label>
</div>
<div class="checkbox-group">
<input type="checkbox" id="useWebWorker" checked>
<label for="useWebWorker">Use Web Worker (Large files)</label>
</div>
<div class="checkbox-group">
<input type="checkbox" id="autoCorrectSettings" checked>
<label for="autoCorrectSettings">Auto-Correct Settings from Metadata</label>
</div>
<div class="checkbox-group">
<input type="checkbox" id="useLayerEncoding">
<label for="useLayerEncoding">üß™ Use experimental custom texture encoding (.layer format)</label>
</div>
</div>
<div class="info-banner" style="margin-top:15px;background:#e3f2fd;border-color:#2196f3;">
<strong>‚ÑπÔ∏è Auto-Correction:</strong> When enabled, brush settings (size, opacity, hardness, etc.) are automatically extracted from file metadata (Procreate .brushset, Photoshop .abr) for 1:1 accuracy.
</div>
<div class="warning-banner" id="layerEncodingWarning" style="display:none;margin-top:15px;">
<h4>‚ö†Ô∏è Experimental Feature Warning</h4>
<p>Custom texture encoding using .layer format is an experimental feature that:</p>
<ul>
<li>Requires Python backend to be running (port 5000)</li>
<li>May not work with all CSP versions</li>
<li>Could produce files that CSP rejects or renders incorrectly</li>
<li>Automatically falls back to standard PNG method if encoding fails</li>
</ul>
<p><strong>Recommendation:</strong> Keep this disabled unless you're testing custom texture support. The standard method works reliably for all brushes.</p>
</div>
</div>
</div>

<div id="pressure" class="tab-content">
<div class="pressure-curve-editor">
<h4>Size Pressure Curve</h4>
<canvas id="sizeCurveCanvas" class="curve-canvas" width="400" height="150"></canvas>
<button class="btn btn-secondary" id="resetSizeCurve" style="margin-top:10px;width:auto">Reset Curve</button>
</div>
<div class="pressure-curve-editor">
<h4>Opacity Pressure Curve</h4>
<canvas id="opacityCurveCanvas" class="curve-canvas" width="400" height="150"></canvas>
<button class="btn btn-secondary" id="resetOpacityCurve" style="margin-top:10px;width:auto">Reset Curve</button>
</div>
<div class="pressure-curve-editor">
<h4>Density Pressure Curve</h4>
<canvas id="densityCurveCanvas" class="curve-canvas" width="400" height="150"></canvas>
<button class="btn btn-secondary" id="resetDensityCurve" style="margin-top:10px;width:auto">Reset Curve</button>
</div>
</div>

<div id="debug" class="tab-content">
<div class="debug-panel">
<h4>üîç CSP Schema Validation</h4>
<p>Comprehensive CSP 1.12.3+ compatibility analysis.</p>
<div class="control-group">
<label for="debugMode">Analysis Mode</label>
<select id="debugMode">
<option value="csp">CSP Full Validation</option>
<option value="schema">Schema Validation</option>
<option value="structure">Database Structure</option>
<option value="binary">Binary Headers</option>
<option value="performance">Performance Analysis</option>
</select>
</div>
<button class="btn btn-danger" id="runDebugAnalysis">üîç Run Analysis</button>
<div id="debugResults" class="debug-info" style="display:none;margin-top:15px;"></div>
<div id="validationReport" class="validation-report" style="display:none;margin-top:15px;">
<h5>üìã Validation Report</h5>
<div id="validationDetails"></div>
</div>
<div class="schema-comparison" id="schemaComparison" style="display:none;">
<h5>üìä CSP Schema Comparison</h5>
<table id="schemaTable">
<thead>
<tr><th>Table</th><th>Required</th><th>Found</th><th>Status</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<div
