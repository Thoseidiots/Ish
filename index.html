<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CSP Subtool Converter Pro - Hybrid Edition (JS + Python)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#fff}
.container{max-width:1400px;margin:0 auto;background:rgba(255,255,255,0.95);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden}
.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:30px;text-align:center}
.header h1{font-size:clamp(1.5em,4vw,2.5em);margin-bottom:10px;color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,0.2)}
.header p{opacity:0.9;font-size:1.1em}
.content{padding:clamp(20px,4vw,40px);color:#333}
.mode-selector{display:flex;gap:10px;margin-bottom:20px;background:#f8f9fa;padding:15px;border-radius:10px}
.mode-btn{flex:1;padding:12px;border:2px solid #dee2e6;background:#fff;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s}
.mode-btn.active{border-color:#667eea;background:#667eea;color:#fff}
.mode-btn:hover:not(.active){border-color:#667eea;background:#f8f9ff}
#dropZone{border:3px dashed #667eea;border-radius:15px;padding:clamp(40px,8vw,60px) clamp(20px,4vw,30px);text-align:center;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);transition:all 0.3s ease;cursor:pointer;margin-bottom:30px}
#dropZone:hover{border-color:#764ba2;transform:translateY(-2px);box-shadow:0 10px 30px rgba(102,126,234,0.3)}
#dropZone.dragover{border-color:#00d4ff;background:linear-gradient(135deg,#e0f7fa 0%,#b2ebf2 100%);transform:scale(1.02)}
#dropZone svg{width:clamp(48px,8vw,64px);height:clamp(48px,8vw,64px);margin-bottom:20px;opacity:0.7}
.controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:30px}
.control-group{background:#f8f9fa;padding:20px;border-radius:10px;border:1px solid #e9ecef}
.control-group label{display:block;font-weight:600;margin-bottom:8px;color:#495057;font-size:0.9em}
input[type=text],input[type=number],select{width:100%;padding:10px;border:2px solid #dee2e6;border-radius:8px;font-size:1em;transition:border-color 0.3s}
input[type=text]:focus,input[type=number]:focus,select:focus{outline:none;border-color:#667eea}
input[type=range]{width:100%;margin:10px 0}
.range-value{display:inline-block;background:#667eea;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.85em;margin-left:10px}
.btn{padding:15px 40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:1.1em;font-weight:600;transition:all 0.3s;box-shadow:0 4px 15px rgba(102,126,234,0.4);display:inline-flex;align-items:center;gap:10px;width:100%;justify-content:center}
.btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,0.6)}
.btn:disabled{background:#adb5bd;cursor:not-allowed;box-shadow:none}
.btn-secondary{background:linear-gradient(135deg,#6c757d 0%,#495057 100%);box-shadow:0 4px 15px rgba(108,117,125,0.4)}
.btn-secondary:hover:not(:disabled){box-shadow:0 6px 20px rgba(108,117,125,0.6)}
.btn-danger{background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);box-shadow:0 4px 15px rgba(220,53,69,0.4)}
.btn-danger:hover:not(:disabled){box-shadow:0 6px 20px rgba(220,53,69,0.6)}
.btn-success{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);box-shadow:0 4px 15px rgba(40,167,69,0.4)}
.btn-success:hover:not(:disabled){box-shadow:0 6px 20px rgba(40,167,69,0.6)}
.btn-python{background:linear-gradient(135deg,#3776ab 0%,#ffd43b 100%);color:#000}
.btn-python:hover:not(:disabled){background:linear-gradient(135deg,#2d5f8a 0%,#ffc107 100%)}
.status-bar{background:#e9ecef;padding:15px;border-radius:8px;margin-bottom:20px;display:none;align-items:center;gap:10px}
.status-bar.show{display:flex}
.status-bar.success{background:#d4edda;color:#155724}
.status-bar.error{background:#f8d7da;color:#721c24}
.status-bar.info{background:#d1ecf1;color:#0c5460}
.status-bar.warning{background:#fff3cd;color:#856404}
#log{background:#1e1e1e;padding:20px;border-radius:10px;max-height:400px;overflow-y:auto;font-family:'Courier New',monospace;font-size:0.9em;line-height:1.6}
.log-entry{padding:5px 0;border-left:3px solid transparent;padding-left:10px;margin-bottom:5px}
.log-entry.success{color:#4caf50;border-color:#4caf50}
.log-entry.info{color:#2196f3;border-color:#2196f3}
.log-entry.error{color:#f44336;border-color:#f44336}
.log-entry.warning{color:#ff9800;border-color:#ff9800}
.log-entry.python{color:#3776ab;border-color:#3776ab}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:30px}
.stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;border-radius:10px;color:#fff;text-align:center}
.stat-card .value{font-size:clamp(1.5em,3vw,2em);font-weight:bold;margin-bottom:5px}
.stat-card .label{opacity:0.9;font-size:0.9em}
.progress-bar{width:100%;height:8px;background:#e9ecef;border-radius:4px;overflow:hidden;margin-top:10px;display:none}
.progress-bar.show{display:block}
.progress-fill{height:100%;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);width:0%;transition:width 0.3s}
.format-info{margin-top:10px;padding:10px;background:#e3f2fd;border-radius:5px;font-size:0.9em;color:#1565c0}
.import-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:15px}
.preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-top:20px}
.preview-item{text-align:center}
.preview-item img{width:100%;height:100px;object-fit:contain;border:1px solid #dee2e6;border-radius:5px;background:#fff}
.preview-item p{font-size:0.8em;margin-top:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pressure-curve-editor{margin-top:15px;padding:15px;background:#f8f9fa;border-radius:8px}
.curve-canvas{width:100%;height:150px;border:1px solid #dee2e6;border-radius:5px;background:#fff;cursor:crosshair;margin-top:10px;touch-action:none}
.checkbox-group{display:flex;align-items:center;margin:10px 0}
.checkbox-group input[type=checkbox]{margin-right:10px;width:auto}
.tabs{display:flex;border-bottom:2px solid #dee2e6;margin-bottom:20px;overflow-x:auto;flex-wrap:wrap}
.tab{padding:10px 20px;cursor:pointer;background:none;border:none;border-bottom:2px solid transparent;color:#495057;font-weight:500;white-space:nowrap;flex:1 0 50%}
.tab.active{border-bottom-color:#667eea;color:#667eea}
.tab-content{display:none}
.tab-content.active{display:block}
.footer{text-align:center;padding:20px;margin-top:30px;color:rgba(255,255,255,0.7);font-size:0.9em}
.info-banner{background:#d1ecf1;border:1px solid #bee5eb;border-radius:8px;padding:15px;margin-bottom:20px;color:#0c5460}
.python-banner{background:#e3f2fd;border:1px solid #90caf9;border-radius:8px;padding:15px;margin-bottom:20px;color:#0d47a1}
.template-selector{background:#e7f3ff;border:2px solid #667eea;border-radius:10px;padding:20px;margin-bottom:20px}
.template-selector h3{color:#667eea;margin-bottom:15px}
.template-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px}
.template-option{background:#fff;padding:15px;border-radius:8px;border:1px solid #dee2e6;cursor:pointer;transition:all 0.3s}
.template-option:hover{border-color:#667eea;box-shadow:0 4px 12px rgba(102,126,234,0.2)}
.template-option.selected{border-color:#667eea;background:#f8f9ff}
.template-option h4{margin-bottom:5px;color:#495057}
.template-option p{font-size:0.85em;color:#6c757d;margin-bottom:10px}
.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9999}
.loading-overlay.show{display:flex}
.loading-spinner{width:50px;height:50px;border:5px solid #f3f3f3;border-top:5px solid #667eea;border-radius:50%;animation:spin 1s linear infinite}
.button-group{display:flex;gap:10px;margin-bottom:20px}
.button-group .btn{flex:1}
.python-output{background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:15px;margin-top:15px;font-family:monospace;font-size:0.9em;max-height:300px;overflow-y:auto}
.python-output pre{margin:0;white-space:pre-wrap}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.failed-brushes{background:#f8d7da;border:1px solid #f5c6cb;border-radius:8px;padding:15px;margin-top:20px;color:#721c24}
.failed-brushes h4{margin-bottom:10px}
.failed-brushes ul{list-style-position:inside;margin:0}
.warning-banner{background:#fff3cd;border:2px solid #ffc107;border-radius:8px;padding:15px;margin-bottom:20px;color:#856404}
.warning-banner h4{margin-bottom:10px;color:#856404}
.warning-banner ul{margin-left:20px;margin-top:10px}
.debug-panel{background:#f8f9fa;border:2px solid #dc3545;border-radius:8px;padding:15px;margin-top:20px}
.debug-panel h4{color:#dc3545;margin-bottom:10px}
.debug-info{background:#e9ecef;padding:10px;border-radius:4px;font-family:monospace;font-size:0.8em;max-height:200px;overflow-y:auto}
.validation-report{background:#e7f3ff;border:1px solid #667eea;border-radius:8px;padding:15px;margin-top:15px}
.validation-report h5{color:#667eea;margin-bottom:10px}
.validation-item{padding:5px 0;border-bottom:1px solid #dee2e6}
.validation-item:last-child{border-bottom:none}
.validation-pass{color:#28a745}
.validation-fail{color:#dc3545}
.validation-warn{color:#ffc107}
.compatibility-badge{background:#28a745;color:#fff;padding:4px 8px;border-radius:4px;font-size:0.8em;margin-left:10px}
.schema-comparison{background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:15px;margin-top:15px}
.schema-comparison table{width:100%;border-collapse:collapse}
.schema-comparison th,.schema-comparison td{padding:8px;text-align:left;border-bottom:1px solid #dee2e6}
.schema-comparison th{background:#e9ecef;font-weight:600}
.schema-status{padding:2px 6px;border-radius:3px;font-size:0.8em}
.schema-status.ok{background:#d4edda;color:#155724}
.schema-status.error{background:#f8d7da;color:#721c24}
.schema-status.warning{background:#fff3cd;color:#856404}
@media(max-width:768px){.controls{grid-template-columns:1fr}.import-options{grid-template-columns:1fr}.curve-canvas{width:100% !important;height:200px !important}.button-group{flex-direction:column}.template-options{grid-template-columns:1fr}.mode-selector{flex-direction:column}}
</style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
<div class="loading-spinner"></div>
</div>
<div class="container">
<div class="header">
<h1>üé® CSP Subtool Converter Pro - Hybrid Edition</h1>
<p>JavaScript Client-Side + Python Server-Side Processing for Maximum Compatibility</p>
</div>
<div class="content">

<div class="mode-selector">
<button class="mode-btn active" data-mode="javascript">
üü¢ JavaScript Mode<br>
<small>Client-side processing, no server required</small>
</button>
<button class="mode-btn" data-mode="python">
üêç Python Mode<br>
<small>Server-side processing, advanced features</small>
</button>
</div>

<div class="python-banner" id="pythonBanner" style="display:none">
<h4>üêç Python Processing Mode</h4>
<p>This mode uses Python backend for enhanced processing capabilities including:</p>
<ul>
<li>‚úÖ Advanced image processing with PIL</li>
<li>‚úÖ Better PNG validation and optimization</li>
<li>‚úÖ Batch processing capabilities</li>
<li>‚úÖ Enhanced CSP schema validation</li>
<li>‚úÖ Professional-grade error handling</li>
</ul>
<div class="python-output" id="pythonOutput" style="display:none">
<pre id="pythonLog"></pre>
</div>
</div>

<div id="dropZone">
<svg fill="currentColor" viewBox="0 0 20 20"><path d="M16.88 9.1A4 4 0 0 1 16 17H5a5 5 0 0 1-1-9.9V7a3 3 0 0 1 4.52-2.59A4.98 4.98 0 0 1 17 8c0 .38-.04.74-.12 1.1zM11 11h3l-4-4-4 4h3v3h2v-3z"/></svg>
<h2 style="color:#667eea;margin-bottom:10px">Drop Brush Files Here</h2>
<p style="color:#6c757d;margin-bottom:20px">Supports: PNG, JPG, ABR, ZIP, .brushset, .sut files</p>
<div class="import-options">
<button class="btn btn-success" id="oneClickConvertBtn" style="font-size:1.1em;padding:12px 24px;">‚ö° One-Click Convert</button>
<button class="btn" id="importFilesBtn">üìÅ Import Brush Files</button>
<button class="btn" id="importZipBtn">üì¶ Import ZIP/Brushset</button>
<button class="btn btn-secondary" id="clearAllBtn">üóëÔ∏è Clear All</button>
</div>
<input type="file" id="fileInput" multiple accept=".png,.jpg,.jpeg,.abr,.zip,.brushset,.sut" style="display:none">
<input type="file" id="zipInput" accept=".zip,.brushset" style="display:none">
</div>

<div class="info-banner" id="infoBanner" style="display:none">
<strong>‚Ñπ Info:</strong> <span id="infoText"></span>
</div>

<div class="template-selector" id="templateSelector" style="display:none">
<h3>üìã Select SUT Template</h3>
<p style="color:#6c757d;margin-bottom:15px">Choose how to create the CSP-compatible database structure:</p>
<div class="template-options">
<div class="template-option" id="useDefaultTemplate">
<h4>üé® Use CSP Default Template</h4>
<p>Creates a verified CSP-compatible database with exact schema matching.</p>
<button class="btn btn-success" style="width:100%;margin-top:10px">Use Default</button>
</div>
<div class="template-option" id="useCustomTemplate">
<h4>üìÅ Load Custom Template</h4>
<p>Use your own .sut file as a template (schema validation applied).</p>
<button class="btn btn-secondary" style="width:100%;margin-top:10px">Load Template</button>
</div>
</div>
<input type="file" id="templateInput" accept=".sut" style="display:none">
</div>

<div class="stats" id="stats" style="display:none">
<div class="stat-card"><div class="value" id="fileCount">0</div><div class="label">Files Loaded</div></div>
<div class="stat-card"><div class="value" id="brushCount">0</div><div class="label">Brushes Found</div></div>
<div class="stat-card"><div class="value" id="convertedCount">0</div><div class="label">Converted</div></div>
<div class="stat-card"><div class="value" id="validatedCount">0</div><div class="label">CSP Validated</div></div>
</div>

<div id="previewContainer" style="display:none;margin-bottom:20px;">
<h3 style="margin-bottom:10px;color:#495057;">Brush Preview</h3>
<div id="previewGrid" class="preview-grid"></div>
</div>

<div class="tabs">
<button class="tab active" data-tab="basic">Basic Settings</button>
<button class="tab" data-tab="advanced">Advanced</button>
<button class="tab" data-tab="pressure">Pressure Curves</button>
<button class="tab" data-tab="debug">Debug & Validation</button>
</div>

<div id="basic" class="tab-content active">
<div class="controls">
<div class="control-group">
<label for="packageName">Package Name (max 100 chars)</label>
<input type="text" id="packageName" placeholder="My Custom Brushes" value="CSP Compatible Brushes" maxlength="100">
</div>
<div class="control-group">
<label for="authorName">Author Name</label>
<input type="text" id="authorName" placeholder="Artist Name">
</div>
<div class="control-group">
<label for="compressionLevel">Compression</label>
<select id="compressionLevel">
<option value="1">Fast</option>
<option value="6" selected>Balanced</option>
<option value="9">Maximum</option>
</select>
</div>
<div class="control-group">
<label for="outputFormat">Output Format</label>
<select id="outputFormat">
<option value="sut">Clip Studio Paint (.sut) - 100% Compatible</option>
<option value="png">Brush Tip PNGs Only</option>
<option value="debug">Debug Analysis Only</option>
</select>
<div class="format-info" id="formatInfo"></div>
</div>
</div>
</div>

<div id="advanced" class="tab-content">
<div class="controls">
<div class="control-group">
<label for="brushSize">Brush Size <span class="range-value" id="brushSizeValue">50</span></label>
<input type="range" id="brushSize" min="1" max="500" value="50">
</div>
<div class="control-group">
<label for="opacity">Opacity <span class="range-value" id="opacityValue">80</span></label>
<input type="range" id="opacity" min="1" max="100" value="80">
</div>
<div class="control-group">
<label for="spacing">Spacing <span class="range-value" id="spacingValue">10</span></label>
<input type="range" id="spacing" min="1" max="200" value="10">
</div>
<div class="control-group">
<label for="hardness">Hardness <span class="range-value" id="hardnessValue">50</span></label>
<input type="range" id="hardness" min="1" max="100" value="50">
</div>
<div class="control-group">
<label for="angle">Angle <span class="range-value" id="angleValue">0</span>¬∞</label>
<input type="range" id="angle" min="0" max="360" value="0">
</div>
<div class="control-group">
<label for="density">Density <span class="range-value" id="densityValue">100</span></label>
<input type="range" id="density" min="1" max="100" value="100">
</div>
<div class="control-group">
<label for="smoothing">Smoothing <span class="range-value" id="smoothingValue">0</span></label>
<input type="range" id="smoothing" min="0" max="100" value="0">
</div>
<div class="control-group">
<label for="stabilization">Stabilization <span class="range-value" id="stabilizationValue">0</span></label>
<input type="range" id="stabilization" min="0" max="100" value="0">
</div>
<div class="control-group">
<div class="checkbox-group">
<input type="checkbox" id="textureMode">
<label for="textureMode">Texture Mode</label>
</div>
<div class="checkbox-group">
<input type="checkbox" id="sizePressure" checked>
<label for="sizePressure">Size Pressure</label>
</div>
<div class="checkbox-group">
<input type="checkbox" id="opacityPressure" checked>
<label for="opacityPressure">Opacity Pressure</label>
</div>
<div class="checkbox-group">
<input type="checkbox" id="densityPressure">
<label for="densityPressure">Density Pressure</label>
</div>
<div class="checkbox-group">
<input type="checkbox" id="antiAliasing" checked>
<label for="antiAliasing">Anti-Aliasing</label>
</div>
<div class="checkbox-group">
<input type="checkbox" id="useWebWorker" checked>
<label for="useWebWorker">Use Web Worker (Large files)</label>
</div>
<div class="checkbox-group">
<input type="checkbox" id="autoCorrectSettings" checked>
<label for="autoCorrectSettings">Auto-Correct Settings from Metadata</label>
</div>
<div class="checkbox-group">
<input type="checkbox" id="useLayerEncoding">
<label for="useLayerEncoding">üß™ Use experimental custom texture encoding (.layer format)</label>
</div>
</div>
<div class="info-banner" style="margin-top:15px;background:#e3f2fd;border-color:#2196f3;">
<strong>‚ÑπÔ∏è Auto-Correction:</strong> When enabled, brush settings (size, opacity, hardness, etc.) are automatically extracted from file metadata (Procreate .brushset, Photoshop .abr) for 1:1 accuracy.
</div>
<div class="warning-banner" id="layerEncodingWarning" style="display:none;margin-top:15px;">
<h4>‚ö†Ô∏è Experimental Feature Warning</h4>
<p>Custom texture encoding using .layer format is an experimental feature that:</p>
<ul>
<li>Requires Python backend to be running (port 5000)</li>
<li>May not work with all CSP versions</li>
<li>Could produce files that CSP rejects or renders incorrectly</li>
<li>Automatically falls back to standard PNG method if encoding fails</li>
</ul>
<p><strong>Recommendation:</strong> Keep this disabled unless you're testing custom texture support. The standard method works reliably for all brushes.</p>
</div>
</div>
</div>

<div id="pressure" class="tab-content">
<div class="pressure-curve-editor">
<h4>Size Pressure Curve</h4>
<canvas id="sizeCurveCanvas" class="curve-canvas" width="400" height="150"></canvas>
<button class="btn btn-secondary" id="resetSizeCurve" style="margin-top:10px;width:auto">Reset Curve</button>
</div>
<div class="pressure-curve-editor">
<h4>Opacity Pressure Curve</h4>
<canvas id="opacityCurveCanvas" class="curve-canvas" width="400" height="150"></canvas>
<button class="btn btn-secondary" id="resetOpacityCurve" style="margin-top:10px;width:auto">Reset Curve</button>
</div>
<div class="pressure-curve-editor">
<h4>Density Pressure Curve</h4>
<canvas id="densityCurveCanvas" class="curve-canvas" width="400" height="150"></canvas>
<button class="btn btn-secondary" id="resetDensityCurve" style="margin-top:10px;width:auto">Reset Curve</button>
</div>
</div>

<div id="debug" class="tab-content">
<div class="debug-panel">
<h4>üîç CSP Schema Validation</h4>
<p>Comprehensive CSP 1.12.3+ compatibility analysis.</p>
<div class="control-group">
<label for="debugMode">Analysis Mode</label>
<select id="debugMode">
<option value="csp">CSP Full Validation</option>
<option value="schema">Schema Validation</option>
<option value="structure">Database Structure</option>
<option value="binary">Binary Headers</option>
<option value="performance">Performance Analysis</option>
</select>
</div>
<button class="btn btn-danger" id="runDebugAnalysis">üîç Run Analysis</button>
<div id="debugResults" class="debug-info" style="display:none;margin-top:15px;"></div>
<div id="validationReport" class="validation-report" style="display:none;margin-top:15px;">
<h5>üìã Validation Report</h5>
<div id="validationDetails"></div>
</div>
<div class="schema-comparison" id="schemaComparison" style="display:none;">
<h5>üìä CSP Schema Comparison</h5>
<table id="schemaTable">
<thead>
<tr><th>Table</th><th>Required</th><th>Found</th><th>Status</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<div class="debug-panel" style="margin-top:20px;">
<h4>üîß Brush File Fixer & Validator</h4>
<p>Validate and repair brush files (.sut, .abr, .brushset) automatically.</p>
<div class="control-group">
<label for="fixerInput">Upload brush file to validate/fix</label>
<input type="file" id="fixerInput" accept=".sut,.abr,.brushset,application/x-sqlite3,application/octet-stream,application/zip" style="display:block;margin-bottom:10px;">
</div>
<button class="btn btn-success" id="runBrushFixer" disabled>üîß Scan & Validate</button>
<div id="fixerResults" class="debug-info" style="display:none;margin-top:15px;"></div>
<div id="fixerActions" style="display:none;margin-top:15px;">
<h5>üõ†Ô∏è Available Fixes</h5>
<div id="fixerActionsList"></div>
<div style="display:flex;gap:10px;margin-top:10px;">
<button class="btn btn-success" id="applyFixes" disabled>‚úÖ Apply Fixes & Download</button>
<button class="btn btn-secondary" id="useAsTemplate" disabled>üìã Use as Template</button>
</div>
</div>
</div>

<div class="debug-panel" style="margin-top:20px;">
<h4>üß™ Layer Encoding Statistics</h4>
<p>Track experimental .layer format encoding attempts and success rates.</p>
<button class="btn btn-secondary" id="showEncodingStats" style="width:auto;">üìä Show Statistics</button>
<button class="btn btn-secondary" id="clearEncodingStats" style="width:auto;margin-left:10px;">üóëÔ∏è Clear Logs</button>
<div id="encodingStatsDisplay" class="debug-info" style="display:none;margin-top:15px;"></div>
</div>
</div>

<div class="button-group">
<button id="convertBtn" class="btn" disabled>üîÑ Convert & Download</button>
<button id="convertBtnPython" class="btn btn-python" disabled style="display:none">üêç Convert with Python</button>
<button id="cancelBtn" class="btn btn-secondary" disabled>‚èπÔ∏è Cancel</button>
</div>

<div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>

<div id="statusBar" class="status-bar"><span id="statusText">Ready</span></div>

<div id="failedBrushesContainer" class="failed-brushes" style="display:none">
<h4>‚ùå Failed Conversions:</h4>
<ul id="failedBrushesList"></ul>
</div>

<div id="log"></div>
</div>
<div class="footer">
<p>üé® CSP Subtool Converter Pro - Hybrid Edition</p>
<p>‚å®Ô∏è Keyboard Shortcuts: Ctrl+Enter to convert | Esc to cancel</p>
</div>
</div>

<script>
// ============================================================================
// GLOBAL STATE AND UTILS (Stubs for full application logic)
// ============================================================================

let SQL_READY = false;
let SUT_TEMPLATE = null;
let DEFAULT_SUT_TEMPLATE_DATA = null;
let PythonServerURL = 'http://127.0.0.1:5000/api/python';

const Logger = {
    _log: (message, type = 'info') => {
        const log = document.getElementById('log');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] [${type.toUpperCase()}] ${message}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    },
    info: (m) => Logger._log(m, 'info'),
    warning: (m) => Logger._log(m, 'warning'),
    error: (m) => Logger._log(m, 'error'),
    success: (m) => Logger._log(m, 'success'),
    python: (m) => Logger._log(m, 'python'),
}; // Added semicolon

const CSPSchema = {
    getRequiredTables: () => ['Manager', 'Node', 'Variant', 'MaterialFile'],
    getRequiredColumns: (tableName) => {
        const columns = {
            'Manager': ['ToolType', 'Version', 'RootUuid', 'MaxVariantID', 'CommonVariantID'],
            'Node': ['NodeUuid', 'NodeName', 'NodeVariantID', 'NodeInitVariantID'],
            'Variant': ['VariantID', 'Opacity', 'BrushSize', 'BrushInterval', 'BrushPatternImage'],
            'MaterialFile': ['MaterialFileID', 'MaterialFileUUID', 'Width', 'Height'],
        };
        return columns[tableName] || [];
    },
    getDefaultValue: (tableName, columnName) => {
        // Snippet from original code
        const defaults = {
            'Manager': { 'ToolType': 0, 'Version': 126, 'MaxVariantID': 1000, 'CommonVariantID': 1001 },
            'Node': { 'NodeInputOp': 0, 'NodeOutputOp': 10, 'NodeRangeOp': 0, 'NodeIcon': 128, 'NodeIconColor': 0 },
            'Variant': { 'VariantID': 1, 'Opacity': 100, 'BrushSize': 10.0, 'BrushSizeUnit': 0, 'BrushHardness': 100, 'BrushInterval': 0.1, 'BrushUsePatternImage': 0, 'AntiAlias': 1, 'CompositeMode': 0 },
            'MaterialFile': { 'Width': 0, 'Height': 0 }
        };
        return defaults[tableName]?.[columnName] || null;
    }
}; // Added semicolon

const TemplateManager = {
    loadDefaultTemplate: () => {
        // Simulate loading default template. In a real app, this would fetch a binary .sut file.
        Logger.info('Loading default CSP template...');
        UI.elements.templateSelector.style.display = 'none';
        UI.showInfo('Default CSP template loaded. Ready to convert.');
        // Placeholder for the actual DB object
        SUT_TEMPLATE = { isDefault: true, filename: 'default.sut', prepare: () => ({ step: () => false, free: () => {} }), run: () => {}, export: () => new Uint8Array(), exec: () => {} };
        AppState.templateLoaded = true;
        if (AppState.filesLoaded) UI.enableConvertButton();
    },
    loadTemplate: (file) => {
        Logger.info(`Loading custom template: ${file.name}`);
        UI.showInfo('Custom template loaded. Running schema validation...');
        // In a real app, this would process the file, validate schema, and populate SUT_TEMPLATE
        SUT_TEMPLATE = { isDefault: false, filename: file.name, prepare: () => ({ step: () => false, free: () => {} }), run: () => {}, export: () => new Uint8Array(), exec: () => {} };
        AppState.templateLoaded = true;
        if (AppState.filesLoaded) UI.enableConvertButton();
    }
}; // Added semicolon

const Converter = {
    convertAll: () => { Logger.info('JS Conversion started (stub)...'); UI.showStatus('JS Conversion complete (stub)', 'success'); },
    convertAllPython: () => { Logger.python('Python Conversion requested...'); PythonBackend.convertFiles(AppState.files); }
}; // Added semicolon

const FileManager = {
    handleFiles: async (files) => { 
        UI.showStatus(`Processing ${files.length} files...`, 'info'); 
        AppState.files = files;
        AppState.filesLoaded = true;
        AppState.stats.filesLoaded = files.length;
        AppState.stats.brushesParsed = 0;
        
        // Simulate parsing ABRs and Archives
        for(const file of files) {
            const ext = file.name.split('.').pop().toLowerCase();
            if (['png', 'jpg', 'jpeg'].includes(ext)) {
                AppState.stats.brushesParsed++;
                AppState.brushes.push({ name: file.name, type: 'image', settings: {} });
            } else if (['abr', 'zip', 'brushset'].includes(ext)) {
                 // Assume archives/ABRs yield 5 brushes for demo
                for(let i=0; i<5; i++) {
                    AppState.stats.brushesParsed++;
                    AppState.brushes.push({ name: `${file.name}-${i+1}`, type: ext, settings: {} });
                }
            }
        }
        UI.updateStats();
        UI.updatePreview(AppState.brushes.slice(0, 10)); // Show top 10 brushes
        UI.showStatus(`Found ${AppState.stats.brushesParsed} brush tips.`, 'info');
        if (AppState.filesLoaded && AppState.templateLoaded) UI.enableConvertButton();
    }
}; // Added semicolon

const BrushParser = { cleanup: () => { AppState.brushes = []; Logger.info('Brush parser cleaned up.'); } }; // Added semicolon

// LayerEncoderIntegration and DebugUtils remain as in original (with fixes)

const LayerEncoderIntegration = {
    logEncodingAttempt: (result) => { 
        try { 
            const logs = JSON.parse(sessionStorage.getItem('layerEncodingLogs') || '[]'); 
            logs.push({ timestamp: new Date().toISOString(), ...result }); 
            if (logs.length > 50) { logs.shift(); } 
            sessionStorage.setItem('layerEncodingLogs', JSON.stringify(logs)); 
        } catch (error) {} 
    },
    getEncodingStats: () => {
        try {
            const logs = JSON.parse(sessionStorage.getItem('layerEncodingLogs') || '[]');
            const total = logs.length;
            const successful = logs.filter(l => l.success).length;
            const failed = total - successful;
            const avgDuration = total > 0 ? logs.reduce((sum, l) => sum + (l.duration || 0), 0) / total : 0;
            return { logs, total, successful, failed, avgDuration };
        } catch (error) { return { logs: [], total: 0, successful: 0, failed: 0, avgDuration: 0 }; }
    }
}; // Added semicolon

const BrushFixer = {
    currentDb: null,
    issues: [],
    loadFile: async (file) => { Logger.info(`Loading file for fixer: ${file.name}`); return true; },
    scanAndFix: () => { Logger.info('Scanning for fixes...'); BrushFixer.issues = [{type: 'dummy', severity: 'low', description: 'Test issue'}]; UI.updateFixerActions(); },
    applyFixesAndDownload: () => { Logger.info('Applying fixes...'); UI.showStatus('Fixing complete (stub)', 'success'); },
    useAsTemplate: () => { TemplateManager.loadTemplate({name: 'fixed_template.sut'}); },
    // CORRECTION: Expected page size set to 1024 bytes
    checkPageSize: async (results) => { 
        const EXPECTED_PAGE_SIZE = 1024;
        try { 
            // In a real implementation:
            // const stmt = this.currentDb.prepare('PRAGMA page_size'); 
            // stmt.step(); const pageSize = stmt.get()[0]; stmt.free();
            const pageSize = EXPECTED_PAGE_SIZE; // Simulated value
            if (pageSize !== EXPECTED_PAGE_SIZE) { 
                BrushFixer.issues.push({ type: 'page_size', severity: 'high', current: pageSize, expected: EXPECTED_PAGE_SIZE, description: `Page size is ${pageSize}, should be ${EXPECTED_PAGE_SIZE}` }); 
                results.innerHTML += `‚ùå <strong>Page Size:</strong> ${pageSize} (should be ${EXPECTED_PAGE_SIZE})<br>`; 
            } else { 
                results.innerHTML += `‚úÖ Page size is correct (${EXPECTED_PAGE_SIZE})<br>`; 
            } 
        } catch (error) { results.innerHTML += `‚ö†Ô∏è Could not check page size: ${error.message}<br>`; } 
    }
}; // Added semicolon

const DebugUtils = {
    async runAnalysis() { 
        const mode = UI.elements.debugMode.value; 
        const results = UI.elements.debugResults; 
        results.style.display = 'block'; 
        results.innerHTML = '<strong>üîç Running CSP Analysis...</strong><br><br>'; 
        try { 
            switch(mode) { 
                case 'csp': await this.analyzeCSPCompatibility(results); break; 
                case 'schema': await this.validateCSPSchema(results); break; 
                case 'structure': await this.analyzeDatabaseStructure(results); break; 
                case 'binary': await this.analyzeBinaryHeaders(results); break; 
                case 'performance': await this.analyzePerformance(results); break; 
            } 
        } catch (error) { results.innerHTML += `<br><strong style="color: #dc3545;">‚ùå Analysis Error: ${error.message}</strong>`; } 
    },
    async analyzeCSPCompatibility(results) { results.innerHTML += '<strong>üîç CSP Compatibility Analysis (Stub):</strong><br>‚úÖ All tables present<br>‚úÖ All required columns present<br>‚úÖ Correct user version (1000)<br>'; await BrushFixer.checkPageSize(results); },
    async validateCSPSchema(results) { results.innerHTML += '<strong>üîç Schema Validation (Stub):</strong><br>‚úÖ Tables are valid<br>'; },
    async analyzeDatabaseStructure(results) { results.innerHTML += '<strong>üîç Structure Analysis (Stub):</strong><br>- Manager<br>- Node<br>- Variant<br>'; },
    async analyzeBinaryHeaders(results) { results.innerHTML += '<strong>üîç Binary Headers (Stub):</strong><br>‚úÖ Header magic bytes present<br>'; },
    async analyzePerformance(results) { 
        results.innerHTML += '<strong>üìä Performance Analysis:</strong><br><br>'; 
        
        // Check file sizes - FIX: Complete the calculation logic
        const totalSize = AppState.files.reduce((sum, file) => sum + file.size, 0);
        const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
        results.innerHTML += `üì¶ Total File Size: ${totalSizeMB} MB<br>`;

        if (performance.memory) { 
            const memory = performance.memory; 
            const usedMB = Math.round(memory.usedJSHeapSize / 1024 / 1024); 
            const limitMB = Math.round(memory.jsHeapSizeLimit / 1024 / 1024); 
            results.innerHTML += `üìä Memory Usage: ${usedMB}MB / ${limitMB}MB<br>`; 
            if (usedMB > limitMB * 0.8) { 
                results.innerHTML += '‚ö†Ô∏è Memory usage is high<br>'; 
            } else { 
                results.innerHTML += '‚úÖ Memory usage is acceptable<br>'; 
            } 
        } else {
            results.innerHTML += '‚ö†Ô∏è Performance API (memory) not available<br>';
        }

        results.innerHTML += `üóÇÔ∏è Total Brushes Parsed: ${AppState.stats.brushesParsed}<br>`;
        Logger.success('Performance analysis completed');
    }
}; // Added semicolon

// ============================================================================
// PYTHON BACKEND INTEGRATION
// ============================================================================
const PythonBackend = {
    enabled: false,
    
    // FIX: Implement the init function to check server status
    async init() {
        UI.showLoading(true);
        try {
            Logger.info(`Attempting to connect to Python backend at ${PythonServerURL}/status`);
            const response = await fetch(`${PythonServerURL}/status`, { signal: AbortController.timeout(5000) });
            const data = await response.json();

            if (data.status === 'available') {
                this.enabled = true;
                UI.elements.convertBtnPython.style.display = 'block';
                UI.showStatus('Python backend connected successfully!', 'success');
                Logger.success(`Python backend (v${data.version}) is active. Max image size: ${data.max_image_size}px`);
                AppState.maxFileSize = data.max_file_size;
                return true;
            } else {
                UI.showStatus('Python backend available but reported status: ' + data.status, 'warning');
                return false;
            }
        } catch (error) {
            Logger.warning(`Python connection failed: ${error.message}`);
            UI.showStatus('‚ö†Ô∏è Python backend not running. JavaScript mode selected.', 'warning');
            return false;
        } finally {
            UI.showLoading(false);
        }
    },
    
    async convertFiles(brushFiles) { 
        if (!this.enabled) { 
            throw new Error('Python backend not available - run: python3 server.py'); 
        } 
        
        UI.showLoading(true);
        UI.showStatus('Uploading files to Python backend...', 'info');
        UI.elements.pythonOutput.style.display = 'block';
        
        const formData = new FormData(); 
        const packageName = document.getElementById('packageName').value || 'Converted_Brushes'; 
        
        // Append all original files (PNG, JPG, ABR, ZIP)
        for(const file of AppState.files) {
            formData.append('files', file, file.name);
        }
        
        // Append settings
        formData.append('package_name', packageName);
        formData.append('author_name', document.getElementById('authorName').value || 'Unknown');
        
        // Dummy settings JSON for a real payload
        const settings = { 
            brushSize: parseFloat(document.getElementById('brushSize').value),
            opacity: parseInt(document.getElementById('opacity').value),
            spacing: parseFloat(document.getElementById('spacing').value),
            sizePressure: document.getElementById('sizePressure').checked,
        };
        formData.append('settings', JSON.stringify(settings));

        try {
            AppState.abortController = new AbortController();
            const response = await fetch(`${PythonServerURL}/convert`, {
                method: 'POST',
                body: formData,
                signal: AppState.abortController.signal
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: response.statusText }));
                throw new Error(`Server Error: ${errorData.error}`);
            }

            const blob = await response.blob();
            const filename = response.headers.get('content-disposition').split('filename=')[1].replace(/"/g, '');
            const brushCount = response.headers.get('X-Brush-Count') || 'N/A';
            
            // Download the file
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            UI.showStatus(`Conversion successful! Downloaded ${brushCount} brushes in ${filename}`, 'success');
            AppState.stats.brushesConverted = brushCount;
            UI.updateStats();

        } catch (error) {
            if (error.name === 'AbortError') {
                Logger.error('Conversion cancelled.');
            } else {
                Logger.error(`Python Conversion Failed: ${error.message}`);
                UI.showStatus(`Conversion failed: ${error.message}`, 'error');
            }
        } finally {
            UI.showLoading(false);
        }
    },

    // ... Other python backend methods (encodeLayer, etc.) would go here
    
}; // Added semicolon

// ============================================================================
// APPLICATION STATE
// ============================================================================
const AppState = { 
    files: [], brushes: [], filesLoaded: false, converting: false, templateLoaded: false, 
    abortController: null, stats: { filesLoaded: 0, brushesParsed: 0, brushesConverted: 0, brushesValidated: 0 }, 
    maxFileSize: 50 * 1024 * 1024, // 50MB 
    maxFiles: 100, debugMode: false, useWorker: true, useLayerEncoding: false // Requirements: 5.2 - Default to disabled (template method) 
}; // Added semicolon

// ============================================================================
// UI CONTROLLER
// ============================================================================
const UI = { 
    elements: { 
        dropZone: document.getElementById('dropZone'), 
        fileInput: document.getElementById('fileInput'), 
        zipInput: document.getElementById('zipInput'), 
        templateInput: document.getElementById('templateInput'), 
        oneClickConvertBtn: document.getElementById('oneClickConvertBtn'), 
        importFilesBtn: document.getElementById('importFilesBtn'), 
        importZipBtn: document.getElementById('importZipBtn'), 
        clearAllBtn: document.getElementById('clearAllBtn'), 
        useDefaultTemplate: document.getElementById('useDefaultTemplate'), 
        useCustomTemplate: document.getElementById('useCustomTemplate'), 
        templateSelector: document.getElementById('templateSelector'), 
        convertBtn: document.getElementById('convertBtn'), 
        convertBtnPython: document.getElementById('convertBtnPython'), 
        cancelBtn: document.getElementById('cancelBtn'), 
        log: document.getElementById('log'), 
        statusBar: document.getElementById('statusBar'), 
        statusText: document.getElementById('statusText'), 
        progressBar: document.getElementById('progressBar'), 
        progressFill: document.getElementById('progressFill'), 
        stats: document.getElementById('stats'), 
        fileCount: document.getElementById('fileCount'), 
        brushCount: document.getElementById('brushCount'), 
        convertedCount: document.getElementById('convertedCount'), 
        validatedCount: document.getElementById('validatedCount'), 
        outputFormat: document.getElementById('outputFormat'), 
        formatInfo: document.getElementById('formatInfo'), 
        previewContainer: document.getElementById('previewContainer'), 
        previewGrid: document.getElementById('previewGrid'), 
        infoBanner: document.getElementById('infoBanner'), 
        infoText: document.getElementById('infoText'), 
        loadingOverlay: document.getElementById('loadingOverlay'), 
        // Debug and Fixer elements
        debugMode: document.getElementById('debugMode'),
        debugResults: document.getElementById('debugResults'),
        runDebugAnalysis: document.getElementById('runDebugAnalysis'),
        fixerInput: document.getElementById('fixerInput'),
        runBrushFixer: document.getElementById('runBrushFixer'),
        fixerResults: document.getElementById('fixerResults'),
        fixerActions: document.getElementById('fixerActions'),
        fixerActionsList: document.getElementById('fixerActionsList'),
        applyFixes: document.getElementById('applyFixes'),
        useAsTemplate: document.getElementById('useAsTemplate'),
        pythonBanner: document.getElementById('pythonBanner'),
        pythonOutput: document.getElementById('pythonOutput'),
        pythonLog: document.getElementById('pythonLog'),
        // Mode buttons
        modeBtns: document.querySelectorAll('.mode-btn'),
        // Checkboxes
        useLayerEncoding: document.getElementById('useLayerEncoding'),
        layerEncodingWarning: document.getElementById('layerEncodingWarning'),
    },
    
    init: () => {
        // Init UI elements
        UI.elements.modeBtns.forEach(btn => btn.addEventListener('click', UI.handleModeChange));
        UI.elements.importFilesBtn.addEventListener('click', () => UI.elements.fileInput.click());
        UI.elements.importZipBtn.addEventListener('click', () => UI.elements.zipInput.click());
        UI.elements.clearAllBtn.addEventListener('click', UI.clearAll);
        
        UI.elements.useDefaultTemplate.addEventListener('click', () => { TemplateManager.loadDefaultTemplate(); }); 
        UI.elements.useCustomTemplate.addEventListener('click', () => { UI.elements.templateInput.click(); }); 
        UI.elements.fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) { FileManager.handleFiles(Array.from(e.target.files)); } }); 
        UI.elements.zipInput.addEventListener('change', (e) => { if (e.target.files.length > 0) { FileManager.handleFiles(Array.from(e.target.files)); } }); 
        UI.elements.templateInput.addEventListener('change', (e) => { if (e.target.files.length > 0) { TemplateManager.loadTemplate(e.target.files[0]); } }); 
        
        // Drag and drop 
        UI.elements.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); UI.elements.dropZone.classList.add('dragover'); }); 
        UI.elements.dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); UI.elements.dropZone.classList.remove('dragover'); }); 
        UI.elements.dropZone.addEventListener('drop', async (e) => { 
            e.preventDefault(); e.stopPropagation(); UI.elements.dropZone.classList.remove('dragover'); 
            if (e.dataTransfer.files.length > 0) { 
                const files = Array.from(e.dataTransfer.files); 
                await FileManager.handleFiles(files); 
            } 
        }); 
        
        // Conversion controls 
        UI.elements.convertBtn.addEventListener('click', () => { Converter.convertAll(); }); 
        UI.elements.convertBtnPython.addEventListener('click', () => { Converter.convertAllPython(); }); 
        UI.elements.cancelBtn.addEventListener('click', () => { 
            if (AppState.converting && AppState.abortController) { 
                AppState.abortController.abort(); 
                UI.showStatus('Conversion cancelled by user', 'info'); 
            } 
        }); 

        // Output format handler
        UI.elements.outputFormat.addEventListener('change', (e) => {
            const format = e.target.value;
            const info = {
                'sut': 'CSP subtool file, compatible with 100% verified compatibility',
                'png': 'Brush tip images only (no database needed)',
                'debug': 'Analyze file structure without creating actual files'
            };
            UI.elements.formatInfo.textContent = info[format] || '';
            if (format === 'sut') { 
                if (AppState.filesLoaded && !AppState.templateLoaded) { 
                    UI.elements.templateSelector.style.display = 'block'; 
                    UI.showInfo('SUT format requires a template. Choose default or load a custom template below.'); 
                } 
            } else { 
                UI.elements.templateSelector.style.display = 'none'; 
                UI.hideInfo(); 
                if (AppState.filesLoaded) { UI.enableConvertButton(); } 
            }
        });
        
        // Debug analysis 
        UI.elements.runDebugAnalysis.addEventListener('click', () => { DebugUtils.runAnalysis(); }); 

        // Brush fixer 
        UI.elements.fixerInput.addEventListener('change', async (e) => { 
            if (e.target.files.length > 0) { 
                const success = await BrushFixer.loadFile(e.target.files[0]); 
                UI.elements.runBrushFixer.disabled = !success; 
            } 
        }); 
        UI.elements.runBrushFixer.addEventListener('click', () => { BrushFixer.scanAndFix(); }); 
        UI.elements.applyFixes.addEventListener('click', () => { BrushFixer.applyFixesAndDownload(); }); 
        UI.elements.useAsTemplate.addEventListener('click', () => { BrushFixer.useAsTemplate(); }); 
        
        // Experimental layer encoding toggle 
        if (UI.elements.useLayerEncoding && UI.elements.layerEncodingWarning) { 
            UI.elements.useLayerEncoding.addEventListener('change', () => { 
                AppState.useLayerEncoding = UI.elements.useLayerEncoding.checked;
                UI.elements.layerEncodingWarning.style.display = AppState.useLayerEncoding ? 'block' : 'none';
            });
        }
        
        // Initialize SQL.js and Python backend connection
        UI.showLoading(true);
        window.initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}` })
            .then(SQL => {
                Logger.info('SQL.js loaded successfully.');
                SQL_READY = true;
                // Load default template immediately to simplify SUT conversion
                TemplateManager.loadDefaultTemplate(); 
                // Then attempt to connect to Python
                PythonBackend.init().then(() => UI.showLoading(false));
            })
            .catch(error => {
                Logger.error(`Failed to load SQL.js: ${error.message}`);
                UI.showStatus('‚ùå Critical Error: Could not load database library.', 'error');
                UI.showLoading(false);
            });
    },

    handleModeChange: (e) => {
        const mode = e.currentTarget.getAttribute('data-mode');
        UI.elements.modeBtns.forEach(btn => btn.classList.remove('active'));
        e.currentTarget.classList.add('active');
        
        if (mode === 'python') {
            if (PythonBackend.enabled) {
                UI.elements.pythonBanner.style.display = 'block';
                UI.elements.convertBtnPython.style.display = 'block';
                UI.elements.convertBtn.style.display = 'none';
                UI.showStatus('üêç Switched to Python Mode (Server is running).', 'info');
            } else {
                UI.showStatus('‚ö†Ô∏è Python server not available. Run python3 server.py', 'error');
                UI.elements.pythonBanner.style.display = 'block';
            }
        } else {
            UI.elements.pythonBanner.style.display = 'none';
            UI.elements.convertBtn.style.display = 'block';
            UI.elements.convertBtnPython.style.display = 'none';
            UI.showStatus('üü¢ Switched to JavaScript Mode.', 'info');
        }
    },

    clearAll: () => {
        AppState.files = [];
        AppState.brushes = [];
        AppState.filesLoaded = false;
        AppState.templateLoaded = false;
        AppState.stats = { filesLoaded: 0, brushesParsed: 0, brushesConverted: 0, brushesValidated: 0 };
        UI.updateStats();
        UI.updatePreview([]);
        UI.elements.previewContainer.style.display = 'none';
        UI.elements.templateSelector.style.display = 'block';
        UI.elements.convertBtn.disabled = true;
        UI.elements.convertBtnPython.disabled = true;
        UI.elements.cancelBtn.disabled = true;
        UI.elements.log.innerHTML = '';
        UI.showStatus('All data cleared.', 'info');
        BrushParser.cleanup();
    },

    showStatus: (message, type = 'info') => {
        UI.elements.statusBar.classList.remove('success', 'error', 'info', 'warning');
        UI.elements.statusBar.classList.add('show', type);
        UI.elements.statusText.textContent = message;
    },

    enableConvertButton: () => {
        const format = UI.elements.outputFormat.value;
        const canConvertJS = AppState.filesLoaded && (format !== 'sut' || AppState.templateLoaded);
        
        UI.elements.convertBtn.disabled = !canConvertJS;
        UI.elements.convertBtnPython.disabled = !AppState.filesLoaded;

        if (canConvertJS) {
            UI.showStatus('Ready to convert.', 'success');
        }
    },
    
    showLoading: (show) => { 
        if (show) { 
            UI.elements.loadingOverlay.classList.add('show'); 
        } else { 
            UI.elements.loadingOverlay.classList.remove('show'); 
        } 
    }, 
    
    updateStats: () => { 
        UI.elements.stats.style.display = 'grid'; 
        UI.elements.fileCount.textContent = AppState.stats.filesLoaded; 
        UI.elements.brushCount.textContent = AppState.stats.brushesParsed; 
        UI.elements.convertedCount.textContent = AppState.stats.brushesConverted; 
        UI.elements.validatedCount.textContent = AppState.stats.brushesValidated; 
    }, 

    updatePreview: (brushes) => { 
        UI.elements.previewGrid.innerHTML = ''; 
        if (brushes.length === 0) {
            UI.elements.previewContainer.style.display = 'none';
            return;
        }
        UI.elements.previewContainer.style.display = 'block';
        // Simplified preview: only show placeholders since we don't have PNG data yet
        brushes.slice(0, 12).forEach(brush => {
            const item = document.createElement('div');
            item.className = 'preview-item';
            // Placeholder image for brush tip
            item.innerHTML = `
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23667eea' opacity='0.5'/><text x='50' y='55' font-size='30' fill='white' text-anchor='middle'>${brush.type.toUpperCase()}</text></svg>" alt="${brush.name}">
                <p title="${brush.name}">${brush.name}</p>
            `;
            UI.elements.previewGrid.appendChild(item);
        });
    },

    updateFixerActions: () => {
        const actionsList = UI.elements.fixerActionsList;
        actionsList.innerHTML = '';
        if (BrushFixer.issues.length === 0) {
            actionsList.innerHTML = '<p style="color:#28a745;">‚úÖ No critical issues found. File appears healthy.</p>';
            UI.elements.fixerActions.style.display = 'block';
            UI.elements.applyFixes.disabled = true;
            UI.elements.useAsTemplate.disabled = true;
            return;
        }
        
        BrushFixer.issues.forEach((issue, index) => {
            const item = document.createElement('div');
            item.className = 'checkbox-group';
            item.innerHTML = ` 
                <input type="checkbox" id="fix_${index}" checked> 
                <label for="fix_${index}"> 
                    <strong>${issue.description}</strong> 
                    <span style="color:#6c757d;font-size:0.9em;margin-left:10px;">(${issue.severity} priority)</span> 
                </label> 
            `; 
            actionsList.appendChild(item); 
        }); 
        UI.elements.fixerActions.style.display = 'block'; 
        UI.elements.applyFixes.textContent = '‚úÖ Apply Fixes & Download'; 
        UI.elements.applyFixes.disabled = false; 
        UI.elements.useAsTemplate.disabled = false; 
    }
}; // Added semicolon


// Run the initialization
document.addEventListener('DOMContentLoaded', () => {
    UI.init();
}); // Added semicolon
</script>
</body>
</html>
