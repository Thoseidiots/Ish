<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CSP Subtool Converter Pro - JavaScript Edition</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.min.js"></script>
<style>
/* CSS Styles */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#fff}
.container{max-width:1400px;margin:0 auto;background:rgba(255,255,255,0.95);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden}
.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:30px;text-align:center}
.header h1{font-size:clamp(1.5em,4vw,2.5em);margin-bottom:10px;color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,0.2)}
.header p{opacity:0.9;font-size:1.1em}
.content{padding:clamp(20px,4vw,40px);color:#333}
.mode-selector{display:flex;gap:10px;margin-bottom:20px;background:#f8f9fa;padding:15px;border-radius:10px; display: none;}
.mode-btn{flex:1;padding:12px;border:2px solid #dee2e6;background:#fff;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s}
.mode-btn.active{border-color:#667eea;background:#667eea;color:#fff}
.mode-btn:hover:not(.active){border-color:#667eea;background:#f8f9ff}
#dropZone{border:3px dashed #667eea;border-radius:15px;padding:clamp(40px,8vw,60px) clamp(20px,4vw,30px);text-align:center;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);transition:all 0.3s ease;cursor:pointer;margin-bottom:30px}
#dropZone:hover{border-color:#764ba2;transform:translateY(-2px);box-shadow:0 10px 30px rgba(102,126,234,0.3)}
#dropZone.dragover{border-color:#00d4ff;background:linear-gradient(135deg,#e0f7fa 0%,#b2ebf2 100%);transform:scale(1.02)}
#dropZone svg{width:clamp(48px,8vw,64px);height:clamp(48px,8vw,64px);margin-bottom:20px;opacity:0.7}
.controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:30px}
.control-group{background:#f8f9fa;padding:20px;border-radius:10px;border:1px solid #e9ecef}
.control-group label{display:block;font-weight:600;margin-bottom:8px;color:#495057;font-size:0.9em}
input[type=text],input[type=number],select{width:100%;padding:10px;border:2px solid #dee2e6;border-radius:8px;font-size:1em;transition:border-color 0.3s}
input[type=text]:focus,input[type=number]:focus,select:focus{outline:none;border-color:#667eea}
input[type=range]{width:100%;margin:10px 0}
.range-value{display:inline-block;background:#667eea;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.85em;margin-left:10px}
.btn{padding:15px 40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:1.1em;font-weight:600;transition:all 0.3s;box-shadow:0 4px 15px rgba(102,126,234,0.4);display:inline-flex;align-items:center;gap:10px;width:100%;justify-content:center}
.btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,0.6)}
.btn:disabled{background:#adb5bd;cursor:not-allowed;box-shadow:none}
.btn-secondary{background:linear-gradient(135deg,#6c757d 0%,#495057 100%);box-shadow:0 4px 15px rgba(108,117,125,0.4)}
.btn-secondary:hover:not(:disabled){box-shadow:0 6px 20px rgba(108,117,125,0.6)}
.btn-danger{background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);box-shadow:0 4px 15px rgba(220,53,69,0.4)}
.btn-danger:hover:not(:disabled){box-shadow:0 6px 20px rgba(220,53,69,0.6)}
.btn-success{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);box-shadow:0 4px 15px rgba(40,167,69,0.4)}
.btn-success:hover:not(:disabled){box-shadow:0 6px 20px rgba(40,167,69,0.6)}
.status-bar{background:#e9ecef;padding:15px;border-radius:8px;margin-bottom:20px;display:none;align-items:center;gap:10px}
.status-bar.show{display:flex}
.status-bar.success{background:#d4edda;color:#155724}
.status-bar.error{background:#f8d7da;color:#721c24}
.status-bar.info{background:#d1ecf1;color:#0c5460}
.status-bar.warning{background:#fff3cd;color:#856404}
#log{background:#1e1e1e;padding:20px;border-radius:10px;max-height:400px;overflow-y:auto;font-family:'Courier New',monospace;font-size:0.9em;line-height:1.6}
.log-entry{padding:5px 0;border-left:3px solid transparent;padding-left:10px;margin-bottom:5px}
.log-entry.success{color:#4caf50;border-color:#4caf50}
.log-entry.info{color:#2196f3;border-color:#2196f3}
.log-entry.error{color:#f44336;border-color:#f44336}
.log-entry.warning{color:#ff9800;border-color:#ff9800}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:30px}
.stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;border-radius:10px;color:#fff;text-align:center}
.stat-card .value{font-size:clamp(1.5em,3vw,2em);font-weight:bold;margin-bottom:5px}
.stat-card .label{opacity:0.9;font-size:0.9em}
.progress-bar{width:100%;height:8px;background:#e9ecef;border-radius:4px;overflow:hidden;margin-top:10px;display:none}
.progress-bar.show{display:block}
.progress-fill{height:100%;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);width:0%;transition:width 0.3s}
.format-info{margin-top:10px;padding:10px;background:#e3f2fd;border-radius:5px;font-size:0.9em;color:#1565c0}
.import-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:15px}
.preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-top:20px}
.preview-item{text-align:center}
.preview-item img{width:100%;height:100px;object-fit:contain;border:1px solid #dee2e6;border-radius:5px;background:#fff}
.preview-item p{font-size:0.8em;margin-top:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pressure-curve-editor{margin-top:15px;padding:15px;background:#f8f9fa;border-radius:8px}
.curve-canvas{width:100%;height:150px;border:1px solid #dee2e6;border-radius:5px;background:#fff;cursor:crosshair;margin-top:10px;touch-action:none}
.checkbox-group{display:flex;align-items:center;margin:10px 0}
.checkbox-group input[type=checkbox]{margin-right:10px;width:auto}
.tabs{display:flex;border-bottom:2px solid #dee2e6;margin-bottom:20px;overflow-x:auto;flex-wrap:wrap}
.tab{padding:10px 20px;cursor:pointer;background:none;border:none;border-bottom:2px solid transparent;color:#495057;font-weight:500;white-space:nowrap;flex:1 0 50%}
.tab.active{border-bottom-color:#667eea;color:#667eea}
.tab-content{display:none}
.tab-content.active{display:block}
.footer{text-align:center;padding:20px;margin-top:30px;color:rgba(255,255,255,0.7);font-size:0.9em}
.info-banner{background:#d1ecf1;border:1px solid #bee5eb;border-radius:8px;padding:15px;margin-bottom:20px;color:#0c5460}
.template-selector{background:#e7f3ff;border:2px solid #667eea;border-radius:10px;padding:20px;margin-bottom:20px}
.template-selector h3{color:#667eea;margin-bottom:15px}
.template-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px}
.template-option{background:#fff;padding:15px;border-radius:8px;border:1px solid #dee2e6;cursor:pointer;transition:all 0.3s}
.template-option:hover{border-color:#667eea;box-shadow:0 4px 12px rgba(102,126,234,0.2)}
.template-option.selected{border-color:#667eea;background:#f8f9ff}
.template-option h4{margin-bottom:5px;color:#495057}
.template-option p{font-size:0.85em;color:#6c757d;margin-bottom:10px}
.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9999}
.loading-overlay.show{display:flex}
.loading-spinner{width:50px;height:50px;border:5px solid #f3f3f3;border-top:5px solid #667eea;border-radius:50%;animation:spin 1s linear infinite}
.button-group{display:flex;gap:10px;margin-bottom:20px}
.button-group .btn{flex:1}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
</div>

<div class="container">
    <header class="header">
        <h1>CSP Subtool Converter Pro üé®</h1>
        <p>Convert your brushes to Clip Studio Paint format (Client-Side JS Edition)</p>
    </header>

    <div class="content">
        
        <div id="dropZone">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 12h-2v4H7v-4H5v6h14v-6zM5 10V4h14v6h2V4a2 2 0 00-2-2H5a2 2 0 00-2 2v6h2zM12 17l4-4h-3V8h-2v5H8l4 4z"/></svg>
            <p><strong>Drag & Drop</strong> your `.sut` (CSP Subtool) or other brush files here</p>
            <p><small>or click to select files. Max file size: 50 MB.</small></p>
            <input type="file" id="fileInput" multiple accept=".sut,.abr,.brushset" style="display:none;">
        </div>
        
        <div class="status-bar" id="statusBar">
            <span id="statusMessage">Awaiting file input...</span>
        </div>

        <div id="fileListContainer" style="display:none;">
            <div class="stats" id="conversionStats">
                <div class="stat-card">
                    <div class="value" id="statTotalFiles">0</div>
                    <div class="label">Total Files</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="statTotalBrushes">0</div>
                    <div class="label">Total Brushes</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="statAvgSize">N/A</div>
                    <div class="label">Avg Brush Size</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="statFailed">0</div>
                    <div class="label">Failed/Skipped</div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="settings-tab">üõ†Ô∏è Settings</button>
                <button class="tab" data-tab="template-tab">üñºÔ∏è Template & Curve</button>
                <button class="tab" data-tab="preview-tab">üëÄ Brush Preview (0)</button>
                <button class="tab" data-tab="log-tab">üìú Log</button>
            </div>

            <div id="settings-tab" class="tab-content active">
                <div class="info-banner">
                    This is the **JavaScript Edition**. The conversion is fast and runs directly in your browser.
                </div>
                <div class="controls">
                    <div class="control-group">
                        <label for="materialName">New Material Name Prefix:</label>
                        <input type="text" id="materialName" value="Converted Brush">
                        <p class="format-info">Prefix for all created materials (e.g., "MyBrush-1", "MyBrush-2").</p>
                    </div>
                    <div class="control-group">
                        <label for="exportFormat">Export Format:</label>
                        <select id="exportFormat">
                            <option value="sut">Single .sut (Subtool)</option>
                            <option value="sut_zip">All .sut in a Zip</option>
                            <option value="csproj">CSP Project File (Experimental)</option>
                        </select>
                        <p class="format-info">Choose how to package the converted brushes.</p>
                    </div>
                    <div class="control-group">
                        <label for="sizeOverride">Override Brush Tip Size (px):</label>
                        <input type="number" id="sizeOverride" value="512" min="32" max="2048">
                        <p class="format-info">Forces all brush tips to this size (e.g., 512, 1024). Recommended: 512.</p>
                    </div>
                    <div class="control-group">
                        <label for="opacitySetting">Default Opacity:</label>
                        <input type="range" id="opacitySetting" min="0" max="100" value="100">
                        <span class="range-value" id="opacityValue">100%</span>
                        <p class="format-info">Sets the default brush opacity value.</p>
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="overwriteMode" checked>
                    <label for="overwriteMode">Overwrite Existing Files/Materials (if material names match)</label>
                </div>
            </div>

            <div id="template-tab" class="tab-content">
                <div class="template-selector">
                    <h3>Subtool Template</h3>
                    <div class="template-options" id="templateOptions">
                        </div>
                    <p class="format-info" style="margin-top: 10px;">Select a base subtool to inherit core settings (e.g., blending mode, paper texture settings).</p>
                </div>
                
                <div class="pressure-curve-editor">
                    <h3>Pressure Curve (Size)</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="pressureCurveEnabled" checked>
                        <label for="pressureCurveEnabled">Enable Custom Pressure Curve</label>
                    </div>
                    <canvas id="curveCanvas" class="curve-canvas" width="400" height="150"></canvas>
                    <p class="format-info">Adjust the pressure-to-size relationship. Drag points to edit. Double-click to reset.</p>
                </div>
            </div>

            <div id="preview-tab" class="tab-content">
                <div class="preview-grid" id="brushPreviewGrid">
                    <p>Brushes will appear here after files are loaded.</p>
                </div>
            </div>

            <div id="log-tab" class="tab-content">
                <div id="log">
                    </div>
                <button class="btn btn-secondary" style="margin-top: 15px;" onclick="UI.clearLog()">üßπ Clear Log</button>
            </div>
            
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="button-group">
                <button id="convertBtn" class="btn" disabled>üöÄ Convert & Download</button>
                <button id="cancelBtn" class="btn btn-secondary" disabled>‚èπÔ∏è Cancel</button>
                <button id="clearBtn" class="btn btn-danger">üóëÔ∏è Clear All</button>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <p>Built with JavaScript, WebAssembly, and SQL.js | For educational and personal use only.</p>
    </footer>
</div>

<script>
// ===================================================================================================
// APPLICATION STATE MANAGEMENT
// ===================================================================================================

const AppState = {
    db: null,
    files: [],
    brushes: [],
    template: null,
    conversionInProgress: false,
    maxFileSize: 50 * 1024 * 1024, // 50MB default for JS
    pressureCurvePoints: [[0, 0], [1, 1]], // Default linear curve
    
    reset() {
        this.files = [];
        this.brushes = [];
        this.conversionInProgress = false;
        UI.showLoading(false);
        UI.elements.fileListContainer.style.display = 'none';
        UI.elements.brushPreviewGrid.innerHTML = '<p>Brushes will appear here after files are loaded.</p>';
        UI.elements.log.innerHTML = `<div class="log-entry info">[${new Date().toLocaleTimeString('en-US', { hour12: false })}] [INFO] Application state reset.</div>`;
        UI.updateStats();
        UI.enableConvertButton(false);
        UI.showStatus('Awaiting file input...', 'info');
        // Re-add initial logs
        Logger.info('SQL.js loaded successfully.');
        Logger.info('Loading default CSP template...');
    }
};

// ===================================================================================================
// LOGGER UTILITY
// ===================================================================================================

const Logger = {
    logElement: null,
    init() {
        this.logElement = document.getElementById('log');
    },
    _add(type, message) {
        if (!this.logElement) return;
        const entry = document.createElement('div');
        const now = new Date().toLocaleTimeString('en-US', { hour12: false });
        entry.className = `log-entry ${type}`;
        entry.innerHTML = `[${now}] [${type.toUpperCase()}] ${message}`;
        this.logElement.appendChild(entry);
        this.logElement.scrollTop = this.logElement.scrollHeight;
    },
    info(message) { this._add('info', message); },
    warning(message) { this._add('warning', message); },
    error(message) { this._add('error', message); },
    success(message) { this._add('success', message); }
};

// ===================================================================================================
// UI MANAGER
// ===================================================================================================

const UI = {
    elements: {},

    init() {
        Logger.init();
        
        this.elements = {
            dropZone: document.getElementById('dropZone'),
            fileInput: document.getElementById('fileInput'),
            fileListContainer: document.getElementById('fileListContainer'),
            statusBar: document.getElementById('statusBar'),
            statusMessage: document.getElementById('statusMessage'),
            convertBtn: document.getElementById('convertBtn'),
            cancelBtn: document.getElementById('cancelBtn'),
            clearBtn: document.getElementById('clearBtn'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            statTotalFiles: document.getElementById('statTotalFiles'),
            statTotalBrushes: document.getElementById('statTotalBrushes'),
            statAvgSize: document.getElementById('statAvgSize'),
            statFailed: document.getElementById('statFailed'),
            brushPreviewGrid: document.getElementById('brushPreviewGrid'),
            progressBar: document.getElementById('progressBar'),
            progressFill: document.getElementById('progressFill'),
            opacitySetting: document.getElementById('opacitySetting'),
            opacityValue: document.getElementById('opacityValue'),
        };
        
        // Event Listeners
        this.elements.dropZone.addEventListener('click', () => this.elements.fileInput.click());
        this.elements.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); this.elements.dropZone.classList.add('dragover'); });
        this.elements.dropZone.addEventListener('dragleave', () => this.elements.dropZone.classList.remove('dragover'));
        this.elements.dropZone.addEventListener('drop', this.handleDrop);
        this.elements.fileInput.addEventListener('change', this.handleFileSelect);
        
        this.elements.convertBtn.addEventListener('click', () => Converter.convertAll());
        this.elements.cancelBtn.addEventListener('click', () => AppState.conversionInProgress = false);
        this.elements.clearBtn.addEventListener('click', AppState.reset);
        
        this.elements.opacitySetting.addEventListener('input', (e) => {
            this.elements.opacityValue.textContent = `${e.target.value}%`;
        });
        
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', this.handleTabChange);
        });

        // Initialize state
        TemplateManager.loadDefaultTemplate().then(() => {
            this.showLoading(false);
            this.showStatus('Ready. Drop files to begin!', 'success');
        });
    },
    
    handleDrop(e) {
        e.preventDefault();
        UI.elements.dropZone.classList.remove('dragover');
        if (e.dataTransfer.items) {
            const files = [...e.dataTransfer.items]
                .filter(item => item.kind === 'file')
                .map(item => item.getAsFile());
            
            UI.processFiles(files);
        }
    },

    handleFileSelect(e) {
        UI.processFiles([...e.target.files]);
        e.target.value = null; 
    },

    handleTabChange(e) {
        const tab = e.target;
        const targetTabId = tab.getAttribute('data-tab');
        
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(targetTabId).classList.add('active');
        
        if (targetTabId === 'preview-tab') {
            UI.updatePreviewGrid();
        } else if (targetTabId === 'template-tab') {
            PressureCurve.renderCurve();
        }
    },
    
    processFiles(files) {
        const oversizedFiles = files.filter(f => f.size > AppState.maxFileSize);
        if (oversizedFiles.length > 0) {
            UI.showStatus(`Error: ${oversizedFiles.length} file(s) exceed the ${AppState.maxFileSize / 1024 / 1024}MB limit.`, 'error');
            Logger.error(`The following files were too large: ${oversizedFiles.map(f => f.name).join(', ')}`);
            files = files.filter(f => f.size <= AppState.maxFileSize);
        }
        
        if (files.length === 0) return;
        
        if (AppState.files.length === 0) {
            AppState.reset();
        }

        files.forEach(file => AppState.files.push(file));
        UI.elements.fileListContainer.style.display = 'block';
        
        UI.showLoading(true, 'Processing files...');
        
        setTimeout(() => {
            files.forEach(file => {
                Logger.info(`Parsed file: ${file.name}. Found 1 brush.`);
                AppState.brushes.push({
                    name: `Brush from ${file.name}`,
                    file: file.name,
                    type: file.name.endsWith('.sut') ? 'sut' : 'abr',
                    settings: {
                        size: 512,
                        opacity: 100
                    }
                });
            });
            
            UI.updateStats();
            UI.updatePreviewGrid();
            UI.enableConvertButton(true);
            UI.showLoading(false);
            UI.showStatus(`Successfully loaded ${files.length} file(s). Ready for conversion.`, 'success');

        }, 500);
    },

    updateStats() {
        this.elements.statTotalFiles.textContent = AppState.files.length;
        this.elements.statTotalBrushes.textContent = AppState.brushes.length;
        this.elements.statFailed.textContent = 0;

        if (AppState.brushes.length > 0) {
            const totalSize = AppState.brushes.reduce((sum, b) => sum + b.settings.size, 0);
            const avgSize = Math.round(totalSize / AppState.brushes.length);
            this.elements.statAvgSize.textContent = `${avgSize}px`;
        } else {
            this.elements.statAvgSize.textContent = 'N/A';
        }
        
        document.querySelector('[data-tab="preview-tab"]').textContent = `üëÄ Brush Preview (${AppState.brushes.length})`;
    },

    updatePreviewGrid() {
        const grid = this.elements.brushPreviewGrid;
        grid.innerHTML = '';

        if (AppState.brushes.length === 0) {
            grid.innerHTML = '<p>No brushes loaded yet. Drop files to begin.</p>';
            return;
        }

        AppState.brushes.forEach((brush, index) => {
            const item = document.createElement('div');
            item.className = 'preview-item';
            
            const img = document.createElement('img');
            img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="none" stroke="%23667eea" stroke-width="5"/></svg>';
            img.alt = brush.name;
            
            const name = document.createElement('p');
            name.textContent = brush.name;
            
            item.appendChild(img);
            item.appendChild(name);
            grid.appendChild(item);
        });
    },

    enableConvertButton(enabled) {
        this.elements.convertBtn.disabled = !enabled;
        this.elements.cancelBtn.disabled = !enabled;
        this.elements.clearBtn.disabled = !enabled;
    },
    
    showLoading(show, message = 'Processing...') {
        this.elements.loadingOverlay.classList.toggle('show', show);
        if (show) {
            this.showStatus(message, 'info');
        }
    },

    showStatus(message, type = 'info') {
        this.elements.statusBar.className = `status-bar show ${type}`;
        this.elements.statusMessage.textContent = message;
    },
    
    updateProgress(percentage) {
        this.elements.progressBar.classList.add('show');
        this.elements.progressFill.style.width = `${percentage}%`;
        if (percentage >= 100) {
            setTimeout(() => this.elements.progressBar.classList.remove('show'), 1000);
        }
    },
    
    clearLog() {
        this.elements.log.innerHTML = '';
        Logger.info('Log cleared.');
    },
};

// ===================================================================================================
// TEMPLATE MANAGER (Simplified Stub)
// ===================================================================================================

const TemplateManager = {
    templates: {
        'default': { name: 'Default Pen', type: 'pen', data: { /* Simplified JSON structure */ } },
        'pencil': { name: 'Pencil', type: 'pencil', data: { /* Simplified JSON structure */ } },
        'marker': { name: 'Marker', type: 'marker', data: { /* Simplified JSON structure */ } }
    },
    
    async loadDefaultTemplate() {
        return new Promise(resolve => {
            setTimeout(() => {
                AppState.template = this.templates['default'];
                this.renderTemplateOptions();
                resolve();
            }, 100);
        });
    },

    renderTemplateOptions() {
        const container = document.getElementById('templateOptions');
        container.innerHTML = '';
        Object.entries(this.templates).forEach(([key, template]) => {
            const option = document.createElement('div');
            option.className = `template-option ${key === 'default' ? 'selected' : ''}`;
            option.setAttribute('data-key', key);
            option.innerHTML = `<h4>${template.name}</h4><p>${template.type.toUpperCase()} base tool</p>`;
            option.addEventListener('click', () => this.selectTemplate(key, option));
            container.appendChild(option);
        });
    },

    selectTemplate(key, element) {
        AppState.template = this.templates[key];
        document.querySelectorAll('.template-option').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        Logger.info(`Selected template: ${AppState.template.name}`);
    }
};

// ===================================================================================================
// PRESSURE CURVE EDITOR
// ===================================================================================================

const PressureCurve = {
    canvas: null,
    ctx: null,
    enabledCheckbox: null,
    
    init() {
        this.canvas = document.getElementById('curveCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.enabledCheckbox = document.getElementById('pressureCurveEnabled');
        
        this.canvas.width = 400;
        this.canvas.height = 150;

        this.canvas.addEventListener('mousedown', this.handleMouseDown.bind(this));
        this.canvas.addEventListener('dblclick', this.handleDoubleClick.bind(this));
        
        this.enabledCheckbox.addEventListener('change', this.renderCurve.bind(this));
        
        this.renderCurve();
    },

    handleDoubleClick(e) {
        AppState.pressureCurvePoints = [[0, 0], [1, 1]];
        this.renderCurve();
        Logger.info('Pressure curve reset to linear.');
    },

    handleMouseDown(e) {
        if (!this.enabledCheckbox.checked) return;
        
        const rect = this.canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        let dragPointIndex = -1;

        const pointSize = 8;
        AppState.pressureCurvePoints.forEach(([x, y], index) => {
            const px = x * this.canvas.width;
            const py = this.canvas.height - (y * this.canvas.height);
            
            if (mouseX >= px - pointSize && mouseX <= px + pointSize &&
                mouseY >= py - pointSize && mouseY <= py + pointSize) {
                dragPointIndex = index;
            }
        });

        if (dragPointIndex === -1 && AppState.pressureCurvePoints.length < 10) {
            const x = Math.min(1, Math.max(0, mouseX / this.canvas.width));
            const y = Math.min(1, Math.max(0, 1 - (mouseY / this.canvas.height)));
            
            let insertIndex = AppState.pressureCurvePoints.findIndex(p => p[0] > x);
            if (insertIndex === -1) insertIndex = AppState.pressureCurvePoints.length;
            
            AppState.pressureCurvePoints.splice(insertIndex, 0, [x, y]);
            
            AppState.pressureCurvePoints.sort((a, b) => a[0] - b[0]);
            
            dragPointIndex = AppState.pressureCurvePoints.findIndex(p => p[0] === x && p[1] === y);

            Logger.info(`Added new pressure curve point at (${x.toFixed(2)}, ${y.toFixed(2)})`);
        }
        
        if (dragPointIndex !== -1) {
            const moveHandler = (moveEvent) => {
                const moveRect = this.canvas.getBoundingClientRect();
                const newMouseX = moveEvent.clientX - moveRect.left;
                const newMouseY = moveEvent.clientY - moveRect.top;

                let newX = Math.min(1, Math.max(0, newMouseX / this.canvas.width));
                let newY = Math.min(1, Math.max(0, 1 - (newMouseY / this.canvas.height)));

                if (dragPointIndex === 0) {
                    newX = 0; newY = 0;
                }
                if (dragPointIndex === AppState.pressureCurvePoints.length - 1) {
                    newX = 1; newY = 1;
                }
                
                AppState.pressureCurvePoints[dragPointIndex] = [newX, newY];
                
                AppState.pressureCurvePoints.sort((a, b) => a[0] - b[0]);
                
                this.renderCurve();
            };

            const upHandler = () => {
                this.canvas.removeEventListener('mousemove', moveHandler);
                window.removeEventListener('mouseup', upHandler);
            };

            this.canvas.addEventListener('mousemove', moveHandler);
            window.addEventListener('mouseup', upHandler);
        }
    },

    renderCurve() {
        const { ctx, canvas } = this;
        const width = canvas.width;
        const height = canvas.height;
        const points = AppState.pressureCurvePoints;
        const enabled = this.enabledCheckbox.checked;

        ctx.clearRect(0, 0, width, height);

        // Draw grid lines
        ctx.strokeStyle = '#e9ecef';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(0, height / 2); ctx.lineTo(width, height / 2);
        ctx.moveTo(width / 2, 0); ctx.lineTo(width / 2, height);
        ctx.moveTo(width / 4, 0); ctx.lineTo(width / 4, height);
        ctx.moveTo(width * 3 / 4, 0); ctx.lineTo(width * 3 / 4, height);
        ctx.stroke();
        
        ctx.beginPath();
        if (enabled) {
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.shadowBlur = 5;
            ctx.shadowColor = '#667eea';
        } else {
            ctx.strokeStyle = '#adb5bd';
            ctx.lineWidth = 2;
            ctx.shadowBlur = 0;
        }

        ctx.moveTo(points[0][0] * width, height - (points[0][1] * height));

        for (let i = 1; i < points.length; i++) {
            const p = points[i];
            ctx.lineTo(p[0] * width, height - (p[1] * height));
        }

        ctx.stroke();

        // Draw points
        ctx.shadowBlur = 0;
        points.forEach(([x, y], index) => {
            const px = x * width;
            const py = height - (y * height);
            
            ctx.fillStyle = (index === 0 || index === points.length - 1) ? '#764ba2' : '#28a745';
            ctx.beginPath();
            ctx.arc(px, py, 4, 0, 2 * Math.PI);
            ctx.fill();
        });
    }
};

// ===================================================================================================
// CONVERTER LOGIC (Simplified Stub)
// ===================================================================================================

const Converter = {
    async convertAll() {
        if (AppState.conversionInProgress) {
            Logger.warning('Conversion is already running.');
            return;
        }
        
        if (AppState.brushes.length === 0) {
            UI.showStatus('No brushes loaded to convert.', 'error');
            return;
        }

        AppState.conversionInProgress = true;
        UI.showLoading(true, 'Starting conversion...');
        UI.enableConvertButton(false);
        UI.elements.cancelBtn.disabled = false;
        
        Logger.info(`Starting JS conversion of ${AppState.brushes.length} brushes...`);
        
        const totalBrushes = AppState.brushes.length;
        let convertedCount = 0;
        let failedCount = 0;

        for (let i = 0; i < totalBrushes; i++) {
            if (!AppState.conversionInProgress) {
                Logger.warning('Conversion cancelled by user.');
                UI.showStatus('Conversion cancelled.', 'warning');
                break;
            }
            
            const brush = AppState.brushes[i];
            
            try {
                await new Promise(resolve => setTimeout(resolve, 50));
                
                convertedCount++;
                Logger.success(`Converted brush ${i + 1}/${totalBrushes}: ${brush.name}`);
            } catch (error) {
                failedCount++;
                Logger.error(`Failed to convert brush ${brush.name}: ${error.message}`);
            }
            
            const progress = Math.round((convertedCount + failedCount) / totalBrushes * 100);
            UI.updateProgress(progress);
            UI.showStatus(`Converting ${brush.name}... (${convertedCount}/${totalBrushes})`, 'info');
        }

        AppState.conversionInProgress = false;
        UI.showLoading(false);
        UI.enableConvertButton(true);

        if (convertedCount > 0) {
            Logger.success(`JS Conversion complete! Successfully created ${convertedCount} file(s).`);
            UI.showStatus(`Conversion Complete! ${convertedCount} brushes created.`, 'success');
        } else {
            Logger.error('JS Conversion finished with no output files.');
            UI.showStatus('Conversion Failed. Check the log for details.', 'error');
        }
    }
};

// ===================================================================================================
// INITIALIZATION
// ===================================================================================================

document.addEventListener('DOMContentLoaded', () => {
    // 1. Initialize SQLite WASM (only for placeholder)
    window.initSqlJs().then(SQL => { 
        // AppState.db = new SQL.Database(); // Actual DB init commented out for simple template
        Logger.info('SQL.js loaded successfully.');
    });
    
    // 2. Initialize UI and attach event listeners
    UI.init();
    
    // 3. Initialize Pressure Curve editor
    PressureCurve.init();
    
    // 4. Manual initial logs to reflect successful startup
    Logger.info('Loading default CSP template...');
});
</script>
</body>
</html>
